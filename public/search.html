<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticker Search — Market Pulse</title>
<style>
  :root {
    --bg:#0d1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;
    --text:#e6edf3;--dim:#8b949e;--green:#3fb950;--red:#f85149;
    --yellow:#d29922;--blue:#58a6ff;--purple:#bc8cff;--orange:#f0883e;--cyan:#39d2c0;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.5;}
  a{color:var(--blue);text-decoration:none;}a:hover{text-decoration:underline;}

  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;}
  .header h1{font-size:20px;font-weight:600;} .header h1 span{color:var(--blue);}

  .nav{padding:12px 28px;display:flex;gap:8px;border-bottom:1px solid var(--border);}
  .nav a{padding:6px 14px;border-radius:6px;font-size:13px;font-weight:500;color:var(--dim);transition:all .15s;}
  .nav a:hover{background:var(--surface2);color:var(--text);text-decoration:none;}
  .nav a.active{background:var(--blue);color:#fff;}

  /* Search section */
  .search-section{padding:24px 28px;display:flex;flex-direction:column;gap:16px;}
  .search-row{display:flex;gap:10px;align-items:center;}
  .search-input{flex:1;max-width:480px;background:var(--surface);border:2px solid var(--border);color:var(--text);padding:12px 18px;border-radius:8px;font-size:16px;font-family:'SF Mono','Fira Code',monospace;letter-spacing:1px;transition:border-color .2s;}
  .search-input:focus{outline:none;border-color:var(--blue);}
  .search-input::placeholder{color:var(--dim);font-family:-apple-system,sans-serif;letter-spacing:0;font-size:14px;}
  .btn{border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .15s;display:flex;align-items:center;gap:6px;}
  .btn-primary{background:var(--blue);color:#fff;}.btn-primary:hover{filter:brightness(1.15);}
  .btn-secondary{background:var(--surface2);color:var(--dim);border:1px solid var(--border);padding:11px 20px;}.btn-secondary:hover{color:var(--text);border-color:var(--blue);}
  .btn:disabled{opacity:.5;cursor:not-allowed;}

  /* Loading */
  .spinner{display:none;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;}
  .spinner.show{display:inline-block;}
  @keyframes spin{to{transform:rotate(360deg);}}

  /* Error */
  .error-banner{display:none;background:rgba(248,81,73,.1);border:1px solid var(--red);border-radius:6px;padding:10px 16px;font-size:13px;color:var(--red);}
  .error-banner.show{display:block;}

  /* Layout: results + history side by side */
  .content-layout{display:grid;grid-template-columns:1fr 280px;gap:16px;padding:0 28px 28px;min-height:400px;}

  /* Results */
  .results{display:none;}
  .results.show{display:block;}
  .results-header{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:12px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
  .res-ticker{font-size:28px;font-weight:800;font-family:'SF Mono','Fira Code',monospace;color:var(--blue);text-decoration:none;cursor:pointer;}.res-ticker:hover{text-decoration:underline;filter:brightness(1.2);}
  .tv-chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px;height:400px;}
  .tv-link-btn{display:inline-flex;align-items:center;gap:5px;font-size:11px;color:var(--dim);text-decoration:none;padding:3px 10px;border:1px solid var(--border);border-radius:4px;margin-left:8px;transition:.15s;}.tv-link-btn:hover{color:var(--blue);border-color:var(--blue);text-decoration:none;}
  .res-price{font-size:22px;font-weight:700;font-family:'SF Mono',monospace;}
  .res-score{font-size:14px;font-weight:700;padding:4px 12px;border-radius:6px;}
  .sig-badge{padding:4px 12px;border-radius:5px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
  .sig-strong-buy{background:rgba(63,185,80,.18);color:var(--green);}
  .sig-buy{background:rgba(63,185,80,.1);color:var(--green);}
  .sig-hold{background:rgba(210,153,34,.15);color:var(--yellow);}
  .sig-sell{background:rgba(248,81,73,.12);color:var(--red);}
  .sig-strong-sell{background:rgba(248,81,73,.2);color:var(--red);}

  /* Trade signal box */
  .trade-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:12px;}
  .trade-box h3{font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:8px;}
  .trade-row{display:flex;align-items:center;gap:12px;}
  .ts-badge{padding:5px 14px;border-radius:5px;font-size:13px;font-weight:700;letter-spacing:.3px;white-space:nowrap;}
  .ts-buy-now,.ts-buy-swing,.ts-long-entry{background:rgba(63,185,80,.2);color:#3fb950;border:1px solid rgba(63,185,80,.3);}
  .ts-wait,.ts-wait-dip,.ts-wait-breakout,.ts-wait-pullback{background:rgba(210,153,34,.15);color:#d29922;border:1px solid rgba(210,153,34,.25);}
  .ts-accumulate,.ts-hold-swing{background:rgba(88,166,255,.12);color:#58a6ff;border:1px solid rgba(88,166,255,.25);}
  .ts-hold,.ts-range-bound{background:rgba(139,148,158,.1);color:#8b949e;border:1px solid rgba(139,148,158,.2);}
  .ts-reduce,.ts-exit-swing,.ts-fade-rally{background:rgba(240,136,62,.15);color:#f0883e;border:1px solid rgba(240,136,62,.25);}
  .ts-avoid,.ts-no-setup,.ts-short-entry{background:rgba(248,81,73,.18);color:#f85149;border:1px solid rgba(248,81,73,.3);}
  .trade-reasoning{font-size:12px;color:var(--dim);line-height:1.6;margin-top:8px;}

  /* Trade signal sub-tabs */
  .trade-tabs{display:flex;gap:0;margin-bottom:10px;}
  .trade-tab-btn{padding:6px 14px;font-size:11px;font-weight:600;color:var(--dim);cursor:pointer;border:1px solid var(--border);background:none;transition:.15s;border-radius:0;}
  .trade-tab-btn:first-child{border-radius:6px 0 0 6px;}
  .trade-tab-btn:last-child{border-radius:0 6px 6px 0;}
  .trade-tab-btn:not(:first-child){border-left:none;}
  .trade-tab-btn:hover{color:var(--text);background:var(--surface2);}
  .trade-tab-btn.active{color:var(--blue);border-color:var(--blue);background:rgba(88,166,255,.08);}
  .trade-panel{display:none;}
  .trade-panel.active{display:block;}

  /* Entry/Stop/Target grid */
  .levels-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;}
  .level-card{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;text-align:center;}
  .level-card .l{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
  .level-card .v{font-size:17px;font-weight:700;font-family:'SF Mono','Fira Code',monospace;}
  .level-card.entry .v{color:var(--blue);}
  .level-card.stop .v{color:var(--red);}
  .level-card.target .v{color:var(--green);}
  .rr-badge{display:inline-block;margin-top:8px;padding:3px 10px;border-radius:4px;font-size:12px;font-weight:700;font-family:'SF Mono',monospace;background:rgba(88,166,255,.1);color:var(--blue);border:1px solid rgba(88,166,255,.2);}

  /* Stage Analysis */
  .stage-badge{padding:4px 12px;border-radius:5px;font-size:12px;font-weight:700;letter-spacing:.3px;white-space:nowrap;display:inline-flex;align-items:center;gap:5px;}
  .stage-1{background:rgba(88,166,255,.12);color:#58a6ff;border:1px solid rgba(88,166,255,.25);}
  .stage-2{background:rgba(63,185,80,.18);color:#3fb950;border:1px solid rgba(63,185,80,.3);}
  .stage-3{background:rgba(240,136,62,.15);color:#f0883e;border:1px solid rgba(240,136,62,.25);}
  .stage-4{background:rgba(248,81,73,.18);color:#f85149;border:1px solid rgba(248,81,73,.3);}
  .stage-0{background:rgba(139,148,158,.1);color:#8b949e;border:1px solid rgba(139,148,158,.2);}
  .stage-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:12px;}
  .stage-box h3{font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:10px;}
  .stage-header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  .stage-desc{font-size:12px;color:var(--dim);margin-top:8px;line-height:1.6;}
  .stage-factors{margin-top:10px;display:flex;flex-direction:column;gap:4px;}
  .stage-factor{font-size:11px;color:var(--dim);padding-left:14px;position:relative;}
  .stage-factor::before{content:'›';position:absolute;left:2px;color:var(--blue);font-weight:700;}
  .stage-ma150{display:inline-flex;align-items:center;gap:8px;margin-top:8px;padding:6px 12px;background:var(--surface2);border-radius:6px;border:1px solid var(--border);font-size:12px;}
  .stage-confidence{font-size:10px;font-weight:600;padding:2px 8px;border-radius:3px;text-transform:uppercase;letter-spacing:.3px;}
  .conf-high{background:rgba(63,185,80,.12);color:var(--green);}
  .conf-medium{background:rgba(210,153,34,.12);color:var(--yellow);}
  .conf-low{background:rgba(139,148,158,.1);color:var(--dim);}

  /* Tabs */
  .tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--surface);border-radius:10px 10px 0 0;overflow:hidden;}
  .tab-btn{padding:10px 20px;font-size:12px;font-weight:600;color:var(--dim);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:.15s;}
  .tab-btn:hover{color:var(--text);}
  .tab-btn.active{color:var(--blue);border-bottom-color:var(--blue);}
  .tab-content{display:none;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 10px 10px;padding:16px;}
  .tab-content.active{display:block;}

  /* Stat grid */
  .stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;}
  .stat{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;}
  .stat .l{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
  .stat .v{font-size:18px;font-weight:700;font-family:'SF Mono','Fira Code',monospace;}
  .stat .s{font-size:10px;color:var(--dim);margin-top:2px;}
  .mono{font-family:'SF Mono','Fira Code',monospace;}

  /* Price vs MA visual */
  .ma-visual{display:flex;flex-direction:column;gap:4px;margin-top:12px;padding:12px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);}
  .ma-row{display:flex;align-items:center;gap:8px;font-size:12px;}
  .ma-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

  /* History sidebar */
  .history-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;height:fit-content;position:sticky;top:16px;}
  .history-panel h3{font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
  .history-panel h3 button{background:none;border:none;color:var(--dim);font-size:10px;cursor:pointer;padding:2px 6px;border-radius:3px;}
  .history-panel h3 button:hover{color:var(--red);background:rgba(248,81,73,.1);}
  .history-list{display:flex;flex-direction:column;gap:6px;max-height:500px;overflow-y:auto;}
  .history-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:all .15s;border:1px solid transparent;}
  .history-item:hover{background:var(--surface2);border-color:var(--border);}
  .hi-ticker{font-weight:700;font-family:'SF Mono',monospace;font-size:12px;color:var(--blue);min-width:48px;}
  .hi-score{font-size:11px;font-weight:600;font-family:'SF Mono',monospace;}
  .hi-trade{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;letter-spacing:.3px;}
  .hi-price{font-size:11px;color:var(--dim);font-family:'SF Mono',monospace;margin-left:auto;}
  .hi-time{font-size:9px;color:var(--dim);}
  .empty-history{text-align:center;padding:20px;color:var(--dim);font-size:12px;}

  /* Responsive */
  @media(max-width:900px){.content-layout{grid-template-columns:1fr;}.history-panel{position:static;}}
  @media(max-width:600px){.search-section,.content-layout{padding-left:14px;padding-right:14px;}.stat-grid{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>

<div class="header">
  <h1><span>&#128269;</span> Ticker <span>Search</span></h1>
</div>

<div class="nav">
  <a href="index.html">Dashboard</a>
  <a href="search.html" class="active">Ticker Search</a>
  <a href="sentiment.html">Sentiment</a>
  <a href="feargreed.html">Fear & Greed</a>
  <a href="history.html">History &amp; Changes</a>
  <a href="architecture.html">Architecture</a>
</div>

<div class="search-section">
  <div class="search-row">
    <input type="text" id="tickerInput" class="search-input" placeholder="Enter any ticker symbol (e.g. AAPL, NVDA, TSLA)" autofocus>
    <button class="btn btn-primary" id="searchBtn" onclick="doSearch()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Analyze
    </button>
    <div class="spinner" id="spinner"></div>
  </div>
  <div class="error-banner" id="errorBanner"></div>
</div>

<div class="content-layout">
  <!-- Results -->
  <div class="results" id="results">

    <div class="results-header">
      <a class="res-ticker" id="resTicker" href="#" target="_blank" rel="noopener">—</a>
      <a class="tv-link-btn" id="tvLinkBtn" href="#" target="_blank" rel="noopener" title="Open in TradingView">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        TradingView
      </a>
      <span class="res-price" id="resPrice">—</span>
      <span class="sig-badge" id="resSigBadge">—</span>
      <span class="stage-badge stage-0" id="resStageBadge">—</span>
      <span class="res-score" id="resScore">—</span>
      <span style="margin-left:auto;font-size:11px;color:var(--dim);" id="resTime">—</span>
    </div>

    <!-- TradingView Chart -->
    <div class="tv-chart-wrap" id="tvChartWrap" style="display:none;"></div>

    <!-- Stage Analysis -->
    <div class="stage-box" id="stageBox">
      <h3>Weinstein Stage Analysis</h3>
      <div class="stage-header">
        <span class="stage-badge stage-0" id="stageBadgeLg">—</span>
        <span class="stage-confidence" id="stageConf">—</span>
      </div>
      <div class="stage-desc" id="stageDesc">—</div>
      <div class="stage-ma150" id="stageMa150"></div>
      <div class="stage-factors" id="stageFactors"></div>
    </div>

    <!-- Trade Signals: Position / Swing / Intraday -->
    <div class="trade-box">
      <h3>Trade Signals</h3>
      <div class="trade-tabs">
        <button class="trade-tab-btn active" onclick="switchTradeTab('position')">Position</button>
        <button class="trade-tab-btn" onclick="switchTradeTab('swing')">Swing</button>
        <button class="trade-tab-btn" onclick="switchTradeTab('intraday')">Intraday</button>
      </div>

      <!-- Position Trading Panel -->
      <div class="trade-panel active" id="tp-position">
        <div class="trade-row"><span class="ts-badge" id="tradeBadge">—</span></div>
        <div class="trade-reasoning" id="tradeReasoning">—</div>
      </div>

      <!-- Swing Trading Panel -->
      <div class="trade-panel" id="tp-swing">
        <div class="trade-row"><span class="ts-badge" id="swingBadge">—</span></div>
        <div class="trade-reasoning" id="swingReasoning">—</div>
        <div class="levels-grid" id="swingLevels">
          <div class="level-card entry"><div class="l">Entry Price</div><div class="v" id="swingEntry">—</div></div>
          <div class="level-card stop"><div class="l">Stop Loss</div><div class="v" id="swingStop">—</div></div>
          <div class="level-card target"><div class="l">Target Price</div><div class="v" id="swingTarget">—</div></div>
        </div>
        <div style="text-align:center;"><span class="rr-badge" id="swingRR">R/R: —</span></div>
      </div>

      <!-- Intraday Trading Panel -->
      <div class="trade-panel" id="tp-intraday">
        <div class="trade-row"><span class="ts-badge" id="intradayBadge">—</span></div>
        <div class="trade-reasoning" id="intradayReasoning">—</div>
        <div class="levels-grid" id="intradayLevels">
          <div class="level-card entry"><div class="l">Entry Price</div><div class="v" id="intradayEntry">—</div></div>
          <div class="level-card stop"><div class="l">Stop Loss</div><div class="v" id="intradayStop">—</div></div>
          <div class="level-card target"><div class="l">Target Price</div><div class="v" id="intradayTarget">—</div></div>
        </div>
        <div style="text-align:center;"><span class="rr-badge" id="intradayRR">R/R: —</span></div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('signals')">Signals & Technicals</button>
      <button class="tab-btn" onclick="switchTab('momentum')">Momentum</button>
      <button class="tab-btn" onclick="switchTab('fundamentals')">Fundamentals</button>
    </div>

    <!-- Signals Tab -->
    <div class="tab-content active" id="tab-signals">
      <div class="stat-grid" id="signalsGrid"></div>
      <div class="ma-visual" id="maVisual"></div>
    </div>

    <!-- Momentum Tab -->
    <div class="tab-content" id="tab-momentum">
      <div class="stat-grid" id="momentumGrid"></div>
    </div>

    <!-- Fundamentals Tab -->
    <div class="tab-content" id="tab-fundamentals">
      <div class="stat-grid" id="fundamentalsGrid"></div>
    </div>
  </div>

  <!-- History Sidebar -->
  <div class="history-panel">
    <h3>Recent Searches <button onclick="clearHistory()">Clear</button></h3>
    <div class="history-list" id="historyList">
      <div class="empty-history">No searches yet</div>
    </div>
  </div>
</div>

<script>
let DATA = null;

function scoreColor(s){return s>=70?'var(--green)':s>=55?'var(--yellow)':'var(--red)';}
function fmtEST(dateStr){
  const d = new Date(dateStr);
  return d.toLocaleString('en-US', {timeZone:'America/New_York', month:'numeric', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true}) + ' EST';
}
function scoreHex(s){return s>=70?'#3fb950':s>=55?'#d29922':'#f85149';}
function sigClass(s){return 'sig-'+(s||'hold');}
function tsClass(ts){
  if(!ts) return 'ts-hold';
  const t=ts.toUpperCase();
  // Position signals
  if(t==='BUY NOW') return 'ts-buy-now';
  if(t.includes('ACCUMULATE')) return 'ts-accumulate';
  if(t.includes('REDUCE')) return 'ts-reduce';
  if(t==='AVOID') return 'ts-avoid';
  // Swing signals
  if(t==='BUY SWING') return 'ts-buy-swing';
  if(t==='WAIT FOR DIP') return 'ts-wait-dip';
  if(t==='FADE THE RALLY') return 'ts-fade-rally';
  if(t==='HOLD SWING') return 'ts-hold-swing';
  if(t==='EXIT SWING') return 'ts-exit-swing';
  // Intraday signals
  if(t==='LONG ENTRY') return 'ts-long-entry';
  if(t==='SHORT ENTRY') return 'ts-short-entry';
  if(t==='WAIT FOR BREAKOUT') return 'ts-wait-breakout';
  if(t==='WAIT FOR PULLBACK') return 'ts-wait-pullback';
  if(t==='RANGE BOUND') return 'ts-range-bound';
  if(t==='NO SETUP') return 'ts-no-setup';
  // Fallback
  if(t.includes('WAIT')) return 'ts-wait';
  if(t.includes('HOLD')) return 'ts-hold';
  return 'ts-hold';
}
function fmtMcap(v){if(!v)return '—';if(v>=1e12)return '$'+(v/1e12).toFixed(2)+'T';if(v>=1e9)return '$'+(v/1e9).toFixed(2)+'B';if(v>=1e6)return '$'+(v/1e6).toFixed(0)+'M';return '$'+v;}
function fmtPct(v){if(v===null||v===undefined)return '—';return (v*100).toFixed(1)+'%';}
function fmtNum(v,d){if(v===null||v===undefined)return '—';return Number(v).toFixed(d===undefined?2:d);}
function stat(label,value,color){return `<div class="stat"><div class="l">${label}</div><div class="v" style="${color?'color:'+color:''}">${value}</div></div>`;}

// Enter key
document.getElementById('tickerInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') doSearch();
});

async function doSearch(){
  const input = document.getElementById('tickerInput');
  const ticker = input.value.toUpperCase().trim();
  if(!ticker) return;

  const btn = document.getElementById('searchBtn');
  const spinner = document.getElementById('spinner');
  const errBanner = document.getElementById('errorBanner');

  btn.disabled = true;
  spinner.classList.add('show');
  errBanner.classList.remove('show');

  try {
    const r = await fetch(`/api/ticker/${encodeURIComponent(ticker)}`);
    const data = await r.json();

    if(data.status !== 'success'){
      errBanner.textContent = data.error || 'Search failed';
      errBanner.classList.add('show');
      return;
    }

    DATA = data;
    renderResults(data);
    loadHistory();
  } catch(e) {
    errBanner.textContent = 'Connection error — is the API server running?';
    errBanner.classList.add('show');
  } finally {
    btn.disabled = false;
    spinner.classList.remove('show');
  }
}

function renderResults(d){
  document.getElementById('results').classList.add('show');

  // Header with TradingView link
  const tvUrl = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(d.ticker)}`;
  const resTicker = document.getElementById('resTicker');
  resTicker.textContent = d.ticker;
  resTicker.href = tvUrl;
  document.getElementById('tvLinkBtn').href = tvUrl;

  // Embed TradingView chart widget
  const chartWrap = document.getElementById('tvChartWrap');
  chartWrap.style.display = 'block';
  chartWrap.innerHTML = '';
  const tvWidget = document.createElement('div');
  tvWidget.className = 'tradingview-widget-container';
  tvWidget.innerHTML = `<div id="tv_chart_container"></div>`;
  chartWrap.appendChild(tvWidget);
  const tvScript = document.createElement('script');
  tvScript.type = 'text/javascript';
  tvScript.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
  tvScript.async = true;
  tvScript.textContent = JSON.stringify({
    "autosize": true,
    "symbol": d.ticker,
    "interval": "D",
    "timezone": "America/New_York",
    "theme": "dark",
    "style": "1",
    "locale": "en",
    "backgroundColor": "rgba(22, 27, 34, 1)",
    "gridColor": "rgba(48, 54, 61, 0.5)",
    "hide_side_toolbar": false,
    "allow_symbol_change": true,
    "studies": ["RSI@tv-basicstudies","MACD@tv-basicstudies"],
    "support_host": "https://www.tradingview.com"
  });
  tvWidget.appendChild(tvScript);

  const priceEl = document.getElementById('resPrice');
  priceEl.textContent = '$' + fmtNum(d.price,2);
  priceEl.style.color = d.ytd_return >= 0 ? 'var(--green)' : 'var(--red)';

  const sigBadge = document.getElementById('resSigBadge');
  sigBadge.textContent = d.signal.toUpperCase().replace('-',' ');
  sigBadge.className = 'sig-badge ' + sigClass(d.signal);

  const scoreEl = document.getElementById('resScore');
  scoreEl.textContent = d.score + '/100';
  scoreEl.style.color = scoreHex(d.score);
  scoreEl.style.background = d.score>=70?'rgba(63,185,80,.12)':d.score>=55?'rgba(210,153,34,.12)':'rgba(248,81,73,.12)';

  document.getElementById('resTime').textContent = 'Analyzed: ' + fmtEST(d.timestamp);

  // Stage Analysis
  const sa = d.stage_analysis || {};
  const stageNum = sa.stage || 0;
  const stageName = sa.stage_name || 'Unknown';
  const stageLabel = stageNum > 0 ? `Stage ${stageNum} — ${stageName}` : 'Unknown';

  const resStageBadge = document.getElementById('resStageBadge');
  resStageBadge.textContent = stageLabel;
  resStageBadge.className = 'stage-badge stage-' + stageNum;

  const stageBadgeLg = document.getElementById('stageBadgeLg');
  stageBadgeLg.textContent = stageLabel;
  stageBadgeLg.className = 'stage-badge stage-' + stageNum;

  const confEl = document.getElementById('stageConf');
  confEl.textContent = (sa.confidence || 'low') + ' confidence';
  confEl.className = 'stage-confidence conf-' + (sa.confidence || 'low');

  document.getElementById('stageDesc').textContent = sa.description || '—';

  const ma150El = document.getElementById('stageMa150');
  if (sa.ma150) {
    const aboveMa150 = d.price > sa.ma150;
    ma150El.innerHTML = `<span style="color:var(--dim)">MA150:</span> <span class="mono" style="font-weight:600">$${fmtNum(sa.ma150,2)}</span>
      <span style="color:${aboveMa150?'var(--green)':'var(--red)'}; font-weight:600; font-size:11px;">${aboveMa150?'▲ Above':'▼ Below'} (${sa.price_vs_ma150_pct>=0?'+':''}${fmtNum(sa.price_vs_ma150_pct,1)}%)</span>
      <span style="color:var(--dim); margin-left:8px;">Slope: ${sa.ma150_slope>=0?'+':''}${fmtNum(sa.ma150_slope,2)}%</span>`;
  } else {
    ma150El.innerHTML = '';
  }

  const factorsEl = document.getElementById('stageFactors');
  if (sa.factors && sa.factors.length) {
    factorsEl.innerHTML = sa.factors.map(f => `<div class="stage-factor">${f}</div>`).join('');
  } else {
    factorsEl.innerHTML = '';
  }

  // Position trade signal
  const tradeBadge = document.getElementById('tradeBadge');
  tradeBadge.textContent = d.trade_signal;
  tradeBadge.className = 'ts-badge ' + tsClass(d.trade_signal);
  document.getElementById('tradeReasoning').textContent = d.trade_reasoning;

  // Swing trade signal
  const sw = d.swing_signal || {};
  const swBadge = document.getElementById('swingBadge');
  swBadge.textContent = sw.signal || 'NO SETUP';
  swBadge.className = 'ts-badge ' + tsClass(sw.signal);
  document.getElementById('swingReasoning').textContent = sw.reasoning || '—';
  document.getElementById('swingEntry').textContent = sw.entry_price != null ? '$'+fmtNum(sw.entry_price,2) : '—';
  document.getElementById('swingStop').textContent = sw.stop_loss != null ? '$'+fmtNum(sw.stop_loss,2) : '—';
  document.getElementById('swingTarget').textContent = sw.target_price != null ? '$'+fmtNum(sw.target_price,2) : '—';
  document.getElementById('swingRR').textContent = sw.risk_reward ? 'R/R: '+sw.risk_reward : 'R/R: —';

  // Intraday trade signal
  const id = d.intraday_signal || {};
  const idBadge = document.getElementById('intradayBadge');
  idBadge.textContent = id.signal || 'NO SETUP';
  idBadge.className = 'ts-badge ' + tsClass(id.signal);
  document.getElementById('intradayReasoning').textContent = id.reasoning || '—';
  document.getElementById('intradayEntry').textContent = id.entry_price != null ? '$'+fmtNum(id.entry_price,2) : '—';
  document.getElementById('intradayStop').textContent = id.stop_loss != null ? '$'+fmtNum(id.stop_loss,2) : '—';
  document.getElementById('intradayTarget').textContent = id.target_price != null ? '$'+fmtNum(id.target_price,2) : '—';
  document.getElementById('intradayRR').textContent = id.risk_reward ? 'R/R: '+id.risk_reward : 'R/R: —';

  // Signals & Technicals tab
  const aboveMa20 = d.price > d.ma20;
  const aboveMa50 = d.price > d.ma50;
  const aboveMa200 = d.ma200 != null && d.price > d.ma200;
  const macdBull = d.macd > d.macd_signal;

  document.getElementById('signalsGrid').innerHTML = [
    stat('Score', d.score, scoreHex(d.score)),
    stat('Signal', d.signal.toUpperCase(), scoreHex(d.score)),
    stat('RSI (14)', fmtNum(d.rsi,1), d.rsi>70?'var(--red)':d.rsi<30?'var(--green)':''),
    stat('MACD', fmtNum(d.macd,3), macdBull?'var(--green)':'var(--red)'),
    stat('MACD Signal', fmtNum(d.macd_signal,3), ''),
    stat('MACD Histogram', (d.macd_histogram>0?'▲ ':'▼ ')+Math.abs(d.macd_histogram).toFixed(3), d.macd_histogram>0?'var(--green)':'var(--red)'),
    stat('Volume Ratio', fmtNum(d.volume_ratio,1)+'x', d.volume_ratio>1.2?'var(--green)':d.volume_ratio<0.8?'var(--red)':''),
    stat('Trend Strength', d.trend_strength+'/20', d.trend_strength>=14?'var(--green)':d.trend_strength>=8?'var(--yellow)':'var(--red)'),
  ].join('');

  document.getElementById('maVisual').innerHTML = `
    <div style="font-size:11px;font-weight:600;color:var(--dim);margin-bottom:4px;">PRICE vs MOVING AVERAGES</div>
    <div class="ma-row"><div class="ma-dot" style="background:${aboveMa20?'var(--green)':'var(--red)'}"></div>
      <span>MA20: <span class="mono">$${fmtNum(d.ma20,2)}</span></span>
      <span style="margin-left:auto;color:${aboveMa20?'var(--green)':'var(--red)'};font-weight:600;font-size:11px;">${aboveMa20?'▲ Above':'▼ Below'}</span></div>
    <div class="ma-row"><div class="ma-dot" style="background:${aboveMa50?'var(--green)':'var(--red)'}"></div>
      <span>MA50: <span class="mono">$${fmtNum(d.ma50,2)}</span></span>
      <span style="margin-left:auto;color:${aboveMa50?'var(--green)':'var(--red)'};font-weight:600;font-size:11px;">${aboveMa50?'▲ Above':'▼ Below'}</span></div>
    ${d.ma200!=null?`<div class="ma-row"><div class="ma-dot" style="background:${aboveMa200?'var(--green)':'var(--red)'}"></div>
      <span>MA200: <span class="mono">$${fmtNum(d.ma200,2)}</span></span>
      <span style="margin-left:auto;color:${aboveMa200?'var(--green)':'var(--red)'};font-weight:600;font-size:11px;">${aboveMa200?'▲ Above':'▼ Below'}</span></div>`:''}
  `;

  // Momentum tab
  document.getElementById('momentumGrid').innerHTML = [
    stat('YTD Return', (d.ytd_return>=0?'+':'')+fmtNum(d.ytd_return,1)+'%', d.ytd_return>=0?'var(--green)':'var(--red)'),
    stat('1M Return', (d.return_1m>=0?'+':'')+fmtNum(d.return_1m,1)+'%', d.return_1m>=0?'var(--green)':'var(--red)'),
    stat('3M Return', (d.return_3m>=0?'+':'')+fmtNum(d.return_3m,1)+'%', d.return_3m>=0?'var(--green)':'var(--red)'),
    stat('52W High', '$'+fmtNum(d.high_52w,2), ''),
    stat('52W Low', '$'+fmtNum(d.low_52w,2), ''),
    stat('% from 52W High', fmtNum(d.pct_from_52w_high,1)+'%', d.pct_from_52w_high>-5?'var(--green)':'var(--red)'),
    stat('RS vs MA50', (d.rs_vs_ma50>=0?'+':'')+fmtNum(d.rs_vs_ma50,1)+'%', d.rs_vs_ma50>=0?'var(--green)':'var(--red)'),
    stat('Trend Strength', d.trend_strength+'/20', d.trend_strength>=14?'var(--green)':d.trend_strength>=8?'var(--yellow)':'var(--red)'),
  ].join('');

  // Fundamentals tab
  const f = d.fundamentals || {};
  document.getElementById('fundamentalsGrid').innerHTML = [
    stat('Market Cap', fmtMcap(f.market_cap), ''),
    stat('Sector', f.sector||'—', 'var(--cyan)'),
    stat('Industry', f.industry||'—', 'var(--cyan)'),
    stat('Forward P/E', fmtNum(f.forward_pe,1), ''),
    stat('Trailing P/E', fmtNum(f.trailing_pe,1), ''),
    stat('Revenue Growth', f.revenue_growth!=null?fmtPct(f.revenue_growth):'—', f.revenue_growth!=null?(f.revenue_growth>=0?'var(--green)':'var(--red)'):''),
    stat('Gross Margin', f.gross_margin!=null?fmtPct(f.gross_margin):'—', ''),
    stat('Operating Margin', f.operating_margin!=null?fmtPct(f.operating_margin):'—', f.operating_margin!=null?(f.operating_margin>=0.1?'var(--green)':'var(--yellow)'):''),
    stat('Profit Margin', f.profit_margin!=null?fmtPct(f.profit_margin):'—', f.profit_margin!=null?(f.profit_margin>=0?'var(--green)':'var(--red)'):''),
    stat('EPS (Forward)', fmtNum(f.eps_forward,2), ''),
    stat('EPS (Trailing)', fmtNum(f.eps_trailing,2), ''),
    stat('Dividend Yield', f.dividend_yield!=null?(f.dividend_yield*100).toFixed(2)+'%':'—', ''),
    stat('Beta', fmtNum(f.beta,2), ''),
    stat('Short Float %', f.short_pct_float!=null?fmtPct(f.short_pct_float):'—', f.short_pct_float>0.1?'var(--orange)':''),
    stat('Analyst Target', f.target_price?'$'+fmtNum(f.target_price,0):'—', ''),
    stat('Recommendation', f.recommendation?f.recommendation.toUpperCase().replace('_',' '):'—', f.recommendation==='buy'||f.recommendation==='strong_buy'?'var(--green)':f.recommendation==='sell'?'var(--red)':'var(--yellow)'),
  ].join('');
}

function switchTradeTab(style){
  document.querySelectorAll('.trade-tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.trade-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tp-'+style).classList.add('active');
  document.querySelectorAll('.trade-tab-btn').forEach(b=>{
    if(b.textContent.toLowerCase()===style) b.classList.add('active');
  });
}

function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b=>{
    if(b.textContent.toLowerCase().includes(tab.substring(0,4))) b.classList.add('active');
  });
}

async function loadHistory(){
  try {
    const r = await fetch('/api/history');
    const data = await r.json();
    const list = document.getElementById('historyList');
    const searches = data.searches || [];

    if(!searches.length){
      list.innerHTML = '<div class="empty-history">No searches yet</div>';
      return;
    }

    list.innerHTML = searches.slice(0,50).map(h=>{
      const col = h.score>=70?'var(--green)':h.score>=55?'var(--yellow)':'var(--red)';
      return `<div class="history-item" onclick="searchTicker('${h.ticker}')">
        <span class="hi-ticker">${h.ticker}</span>
        <span class="hi-score" style="color:${col}">${Math.round(h.score)}</span>
        <span class="hi-trade ${tsClass(h.trade_signal)}" style="font-size:8px;padding:1px 5px;border-radius:3px;">${h.trade_signal||h.signal}</span>
        <span class="hi-price">$${h.price?h.price.toFixed(2):'—'}</span>
      </div>`;
    }).join('');
  } catch(e) {
    // API not available, use empty state
  }
}

function searchTicker(ticker){
  document.getElementById('tickerInput').value = ticker;
  doSearch();
}

async function clearHistory(){
  try {
    await fetch('/api/history', {method:'DELETE'});
    loadHistory();
  } catch(e){}
}

// Load history on page load
loadHistory();
</script>
</body>
</html>
