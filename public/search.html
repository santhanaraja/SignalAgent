<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticker Search — Market Pulse</title>
<style>
  :root {
    --bg:#0d1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;
    --text:#e6edf3;--dim:#8b949e;--green:#3fb950;--red:#f85149;
    --yellow:#d29922;--blue:#58a6ff;--purple:#bc8cff;--orange:#f0883e;--cyan:#39d2c0;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.5;}
  a{color:var(--blue);text-decoration:none;}a:hover{text-decoration:underline;}

  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;}
  .header h1{font-size:20px;font-weight:600;} .header h1 span{color:var(--blue);}

  .nav{padding:12px 28px;display:flex;gap:8px;border-bottom:1px solid var(--border);}
  .nav a{padding:6px 14px;border-radius:6px;font-size:13px;font-weight:500;color:var(--dim);transition:all .15s;}
  .nav a:hover{background:var(--surface2);color:var(--text);text-decoration:none;}
  .nav a.active{background:var(--blue);color:#fff;}

  /* Search section */
  .search-section{padding:24px 28px;display:flex;flex-direction:column;gap:16px;}
  .search-row{display:flex;gap:10px;align-items:center;}
  .search-input{flex:1;max-width:480px;background:var(--surface);border:2px solid var(--border);color:var(--text);padding:12px 18px;border-radius:8px;font-size:16px;font-family:'SF Mono','Fira Code',monospace;letter-spacing:1px;transition:border-color .2s;}
  .search-input:focus{outline:none;border-color:var(--blue);}
  .search-input::placeholder{color:var(--dim);font-family:-apple-system,sans-serif;letter-spacing:0;font-size:14px;}
  .btn{border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .15s;display:flex;align-items:center;gap:6px;}
  .btn-primary{background:var(--blue);color:#fff;}.btn-primary:hover{filter:brightness(1.15);}
  .btn-secondary{background:var(--surface2);color:var(--dim);border:1px solid var(--border);padding:11px 20px;}.btn-secondary:hover{color:var(--text);border-color:var(--blue);}
  .btn:disabled{opacity:.5;cursor:not-allowed;}

  /* Loading */
  .spinner{display:none;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;}
  .spinner.show{display:inline-block;}
  @keyframes spin{to{transform:rotate(360deg);}}

  /* Error */
  .error-banner{display:none;background:rgba(248,81,73,.1);border:1px solid var(--red);border-radius:6px;padding:10px 16px;font-size:13px;color:var(--red);}
  .error-banner.show{display:block;}

  /* Layout: results + history side by side */
  .content-layout{display:grid;grid-template-columns:1fr 280px;gap:16px;padding:0 28px 28px;min-height:400px;}

  /* Results */
  .results{display:none;}
  .results.show{display:block;}
  .results-header{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:12px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
  .res-ticker{font-size:28px;font-weight:800;font-family:'SF Mono','Fira Code',monospace;color:var(--blue);}
  .res-price{font-size:22px;font-weight:700;font-family:'SF Mono',monospace;}
  .res-score{font-size:14px;font-weight:700;padding:4px 12px;border-radius:6px;}
  .sig-badge{padding:4px 12px;border-radius:5px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
  .sig-strong-buy{background:rgba(63,185,80,.18);color:var(--green);}
  .sig-buy{background:rgba(63,185,80,.1);color:var(--green);}
  .sig-hold{background:rgba(210,153,34,.15);color:var(--yellow);}
  .sig-sell{background:rgba(248,81,73,.12);color:var(--red);}
  .sig-strong-sell{background:rgba(248,81,73,.2);color:var(--red);}

  /* Trade signal box */
  .trade-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:12px;}
  .trade-box h3{font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:8px;}
  .trade-row{display:flex;align-items:center;gap:12px;}
  .ts-badge{padding:5px 14px;border-radius:5px;font-size:13px;font-weight:700;letter-spacing:.3px;white-space:nowrap;}
  .ts-buy-now{background:rgba(63,185,80,.2);color:#3fb950;border:1px solid rgba(63,185,80,.3);}
  .ts-wait{background:rgba(210,153,34,.15);color:#d29922;border:1px solid rgba(210,153,34,.25);}
  .ts-accumulate{background:rgba(88,166,255,.12);color:#58a6ff;border:1px solid rgba(88,166,255,.25);}
  .ts-hold{background:rgba(139,148,158,.1);color:#8b949e;border:1px solid rgba(139,148,158,.2);}
  .ts-reduce{background:rgba(240,136,62,.15);color:#f0883e;border:1px solid rgba(240,136,62,.25);}
  .ts-avoid{background:rgba(248,81,73,.18);color:#f85149;border:1px solid rgba(248,81,73,.3);}
  .trade-reasoning{font-size:12px;color:var(--dim);line-height:1.6;margin-top:8px;}

  /* Tabs */
  .tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--surface);border-radius:10px 10px 0 0;overflow:hidden;}
  .tab-btn{padding:10px 20px;font-size:12px;font-weight:600;color:var(--dim);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:.15s;}
  .tab-btn:hover{color:var(--text);}
  .tab-btn.active{color:var(--blue);border-bottom-color:var(--blue);}
  .tab-content{display:none;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 10px 10px;padding:16px;}
  .tab-content.active{display:block;}

  /* Stat grid */
  .stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;}
  .stat{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;}
  .stat .l{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
  .stat .v{font-size:18px;font-weight:700;font-family:'SF Mono','Fira Code',monospace;}
  .stat .s{font-size:10px;color:var(--dim);margin-top:2px;}
  .mono{font-family:'SF Mono','Fira Code',monospace;}

  /* Price vs MA visual */
  .ma-visual{display:flex;flex-direction:column;gap:4px;margin-top:12px;padding:12px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);}
  .ma-row{display:flex;align-items:center;gap:8px;font-size:12px;}
  .ma-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

  /* History sidebar */
  .history-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;height:fit-content;position:sticky;top:16px;}
  .history-panel h3{font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
  .history-panel h3 button{background:none;border:none;color:var(--dim);font-size:10px;cursor:pointer;padding:2px 6px;border-radius:3px;}
  .history-panel h3 button:hover{color:var(--red);background:rgba(248,81,73,.1);}
  .history-list{display:flex;flex-direction:column;gap:6px;max-height:500px;overflow-y:auto;}
  .history-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:all .15s;border:1px solid transparent;}
  .history-item:hover{background:var(--surface2);border-color:var(--border);}
  .hi-ticker{font-weight:700;font-family:'SF Mono',monospace;font-size:12px;color:var(--blue);min-width:48px;}
  .hi-score{font-size:11px;font-weight:600;font-family:'SF Mono',monospace;}
  .hi-trade{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;letter-spacing:.3px;}
  .hi-price{font-size:11px;color:var(--dim);font-family:'SF Mono',monospace;margin-left:auto;}
  .hi-time{font-size:9px;color:var(--dim);}
  .empty-history{text-align:center;padding:20px;color:var(--dim);font-size:12px;}

  /* Responsive */
  @media(max-width:900px){.content-layout{grid-template-columns:1fr;}.history-panel{position:static;}}
  @media(max-width:600px){.search-section,.content-layout{padding-left:14px;padding-right:14px;}.stat-grid{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>

<div class="header">
  <h1><span>&#128269;</span> Ticker <span>Search</span></h1>
</div>

<div class="nav">
  <a href="index.html">Dashboard</a>
  <a href="search.html" class="active">Ticker Search</a>
  <a href="history.html">History &amp; Changes</a>
  <a href="architecture.html">Architecture</a>
</div>

<div class="search-section">
  <div class="search-row">
    <input type="text" id="tickerInput" class="search-input" placeholder="Enter any ticker symbol (e.g. AAPL, NVDA, TSLA)" autofocus>
    <button class="btn btn-primary" id="searchBtn" onclick="doSearch()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Analyze
    </button>
    <div class="spinner" id="spinner"></div>
  </div>
  <div class="error-banner" id="errorBanner"></div>
</div>

<div class="content-layout">
  <!-- Results -->
  <div class="results" id="results">

    <div class="results-header">
      <span class="res-ticker" id="resTicker">—</span>
      <span class="res-price" id="resPrice">—</span>
      <span class="sig-badge" id="resSigBadge">—</span>
      <span class="res-score" id="resScore">—</span>
      <span style="margin-left:auto;font-size:11px;color:var(--dim);" id="resTime">—</span>
    </div>

    <!-- Trade Signal -->
    <div class="trade-box">
      <h3>Trade Signal & Reasoning</h3>
      <div class="trade-row">
        <span class="ts-badge" id="tradeBadge">—</span>
      </div>
      <div class="trade-reasoning" id="tradeReasoning">—</div>
    </div>

    <!-- Tabs -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('signals')">Signals & Technicals</button>
      <button class="tab-btn" onclick="switchTab('momentum')">Momentum</button>
      <button class="tab-btn" onclick="switchTab('fundamentals')">Fundamentals</button>
    </div>

    <!-- Signals Tab -->
    <div class="tab-content active" id="tab-signals">
      <div class="stat-grid" id="signalsGrid"></div>
      <div class="ma-visual" id="maVisual"></div>
    </div>

    <!-- Momentum Tab -->
    <div class="tab-content" id="tab-momentum">
      <div class="stat-grid" id="momentumGrid"></div>
    </div>

    <!-- Fundamentals Tab -->
    <div class="tab-content" id="tab-fundamentals">
      <div class="stat-grid" id="fundamentalsGrid"></div>
    </div>
  </div>

  <!-- History Sidebar -->
  <div class="history-panel">
    <h3>Recent Searches <button onclick="clearHistory()">Clear</button></h3>
    <div class="history-list" id="historyList">
      <div class="empty-history">No searches yet</div>
    </div>
  </div>
</div>

<script>
let DATA = null;

function scoreColor(s){return s>=70?'var(--green)':s>=55?'var(--yellow)':'var(--red)';}
function scoreHex(s){return s>=70?'#3fb950':s>=55?'#d29922':'#f85149';}
function sigClass(s){return 'sig-'+(s||'hold');}
function tsClass(ts){
  if(!ts) return 'ts-hold';
  const t=ts.toUpperCase();
  if(t==='BUY NOW') return 'ts-buy-now';
  if(t.includes('WAIT')) return 'ts-wait';
  if(t.includes('ACCUMULATE')) return 'ts-accumulate';
  if(t.includes('HOLD')) return 'ts-hold';
  if(t.includes('REDUCE')) return 'ts-reduce';
  if(t==='AVOID') return 'ts-avoid';
  return 'ts-hold';
}
function fmtMcap(v){if(!v)return '—';if(v>=1e12)return '$'+(v/1e12).toFixed(2)+'T';if(v>=1e9)return '$'+(v/1e9).toFixed(2)+'B';if(v>=1e6)return '$'+(v/1e6).toFixed(0)+'M';return '$'+v;}
function fmtPct(v){if(v===null||v===undefined)return '—';return (v*100).toFixed(1)+'%';}
function fmtNum(v,d){if(v===null||v===undefined)return '—';return Number(v).toFixed(d===undefined?2:d);}
function stat(label,value,color){return `<div class="stat"><div class="l">${label}</div><div class="v" style="${color?'color:'+color:''}">${value}</div></div>`;}

// Enter key
document.getElementById('tickerInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') doSearch();
});

async function doSearch(){
  const input = document.getElementById('tickerInput');
  const ticker = input.value.toUpperCase().trim();
  if(!ticker) return;

  const btn = document.getElementById('searchBtn');
  const spinner = document.getElementById('spinner');
  const errBanner = document.getElementById('errorBanner');

  btn.disabled = true;
  spinner.classList.add('show');
  errBanner.classList.remove('show');

  try {
    const r = await fetch(`/api/ticker/${encodeURIComponent(ticker)}`);
    const data = await r.json();

    if(data.status !== 'success'){
      errBanner.textContent = data.error || 'Search failed';
      errBanner.classList.add('show');
      return;
    }

    DATA = data;
    renderResults(data);
    loadHistory();
  } catch(e) {
    errBanner.textContent = 'Connection error — is the API server running?';
    errBanner.classList.add('show');
  } finally {
    btn.disabled = false;
    spinner.classList.remove('show');
  }
}

function renderResults(d){
  document.getElementById('results').classList.add('show');

  // Header
  document.getElementById('resTicker').textContent = d.ticker;
  const priceEl = document.getElementById('resPrice');
  priceEl.textContent = '$' + fmtNum(d.price,2);
  priceEl.style.color = d.ytd_return >= 0 ? 'var(--green)' : 'var(--red)';

  const sigBadge = document.getElementById('resSigBadge');
  sigBadge.textContent = d.signal.toUpperCase().replace('-',' ');
  sigBadge.className = 'sig-badge ' + sigClass(d.signal);

  const scoreEl = document.getElementById('resScore');
  scoreEl.textContent = d.score + '/100';
  scoreEl.style.color = scoreHex(d.score);
  scoreEl.style.background = d.score>=70?'rgba(63,185,80,.12)':d.score>=55?'rgba(210,153,34,.12)':'rgba(248,81,73,.12)';

  document.getElementById('resTime').textContent = 'Analyzed: ' + new Date(d.timestamp).toLocaleString();

  // Trade signal
  const tradeBadge = document.getElementById('tradeBadge');
  tradeBadge.textContent = d.trade_signal;
  tradeBadge.className = 'ts-badge ' + tsClass(d.trade_signal);
  document.getElementById('tradeReasoning').textContent = d.trade_reasoning;

  // Signals & Technicals tab
  const aboveMa20 = d.price > d.ma20;
  const aboveMa50 = d.price > d.ma50;
  const aboveMa200 = d.ma200 != null && d.price > d.ma200;
  const macdBull = d.macd > d.macd_signal;

  document.getElementById('signalsGrid').innerHTML = [
    stat('Score', d.score, scoreHex(d.score)),
    stat('Signal', d.signal.toUpperCase(), scoreHex(d.score)),
    stat('RSI (14)', fmtNum(d.rsi,1), d.rsi>70?'var(--red)':d.rsi<30?'var(--green)':''),
    stat('MACD', fmtNum(d.macd,3), macdBull?'var(--green)':'var(--red)'),
    stat('MACD Signal', fmtNum(d.macd_signal,3), ''),
    stat('MACD Histogram', (d.macd_histogram>0?'▲ ':'▼ ')+Math.abs(d.macd_histogram).toFixed(3), d.macd_histogram>0?'var(--green)':'var(--red)'),
    stat('Volume Ratio', fmtNum(d.volume_ratio,1)+'x', d.volume_ratio>1.2?'var(--green)':d.volume_ratio<0.8?'var(--red)':''),
    stat('Trend Strength', d.trend_strength+'/20', d.trend_strength>=14?'var(--green)':d.trend_strength>=8?'var(--yellow)':'var(--red)'),
  ].join('');

  document.getElementById('maVisual').innerHTML = `
    <div style="font-size:11px;font-weight:600;color:var(--dim);margin-bottom:4px;">PRICE vs MOVING AVERAGES</div>
    <div class="ma-row"><div class="ma-dot" style="background:${aboveMa20?'var(--green)':'var(--red)'}"></div>
      <span>MA20: <span class="mono">$${fmtNum(d.ma20,2)}</span></span>
      <span style="margin-left:auto;color:${aboveMa20?'var(--green)':'var(--red)'};font-weight:600;font-size:11px;">${aboveMa20?'▲ Above':'▼ Below'}</span></div>
    <div class="ma-row"><div class="ma-dot" style="background:${aboveMa50?'var(--green)':'var(--red)'}"></div>
      <span>MA50: <span class="mono">$${fmtNum(d.ma50,2)}</span></span>
      <span style="margin-left:auto;color:${aboveMa50?'var(--green)':'var(--red)'};font-weight:600;font-size:11px;">${aboveMa50?'▲ Above':'▼ Below'}</span></div>
    ${d.ma200!=null?`<div class="ma-row"><div class="ma-dot" style="background:${aboveMa200?'var(--green)':'var(--red)'}"></div>
      <span>MA200: <span class="mono">$${fmtNum(d.ma200,2)}</span></span>
      <span style="margin-left:auto;color:${aboveMa200?'var(--green)':'var(--red)'};font-weight:600;font-size:11px;">${aboveMa200?'▲ Above':'▼ Below'}</span></div>`:''}
  `;

  // Momentum tab
  document.getElementById('momentumGrid').innerHTML = [
    stat('YTD Return', (d.ytd_return>=0?'+':'')+fmtNum(d.ytd_return,1)+'%', d.ytd_return>=0?'var(--green)':'var(--red)'),
    stat('1M Return', (d.return_1m>=0?'+':'')+fmtNum(d.return_1m,1)+'%', d.return_1m>=0?'var(--green)':'var(--red)'),
    stat('3M Return', (d.return_3m>=0?'+':'')+fmtNum(d.return_3m,1)+'%', d.return_3m>=0?'var(--green)':'var(--red)'),
    stat('52W High', '$'+fmtNum(d.high_52w,2), ''),
    stat('52W Low', '$'+fmtNum(d.low_52w,2), ''),
    stat('% from 52W High', fmtNum(d.pct_from_52w_high,1)+'%', d.pct_from_52w_high>-5?'var(--green)':'var(--red)'),
    stat('RS vs MA50', (d.rs_vs_ma50>=0?'+':'')+fmtNum(d.rs_vs_ma50,1)+'%', d.rs_vs_ma50>=0?'var(--green)':'var(--red)'),
    stat('Trend Strength', d.trend_strength+'/20', d.trend_strength>=14?'var(--green)':d.trend_strength>=8?'var(--yellow)':'var(--red)'),
  ].join('');

  // Fundamentals tab
  const f = d.fundamentals || {};
  document.getElementById('fundamentalsGrid').innerHTML = [
    stat('Market Cap', fmtMcap(f.market_cap), ''),
    stat('Sector', f.sector||'—', 'var(--cyan)'),
    stat('Industry', f.industry||'—', 'var(--cyan)'),
    stat('Forward P/E', fmtNum(f.forward_pe,1), ''),
    stat('Trailing P/E', fmtNum(f.trailing_pe,1), ''),
    stat('Revenue Growth', f.revenue_growth!=null?fmtPct(f.revenue_growth):'—', f.revenue_growth!=null?(f.revenue_growth>=0?'var(--green)':'var(--red)'):''),
    stat('Gross Margin', f.gross_margin!=null?fmtPct(f.gross_margin):'—', ''),
    stat('Operating Margin', f.operating_margin!=null?fmtPct(f.operating_margin):'—', f.operating_margin!=null?(f.operating_margin>=0.1?'var(--green)':'var(--yellow)'):''),
    stat('Profit Margin', f.profit_margin!=null?fmtPct(f.profit_margin):'—', f.profit_margin!=null?(f.profit_margin>=0?'var(--green)':'var(--red)'):''),
    stat('EPS (Forward)', fmtNum(f.eps_forward,2), ''),
    stat('EPS (Trailing)', fmtNum(f.eps_trailing,2), ''),
    stat('Dividend Yield', f.dividend_yield!=null?(f.dividend_yield*100).toFixed(2)+'%':'—', ''),
    stat('Beta', fmtNum(f.beta,2), ''),
    stat('Short Float %', f.short_pct_float!=null?fmtPct(f.short_pct_float):'—', f.short_pct_float>0.1?'var(--orange)':''),
    stat('Analyst Target', f.target_price?'$'+fmtNum(f.target_price,0):'—', ''),
    stat('Recommendation', f.recommendation?f.recommendation.toUpperCase().replace('_',' '):'—', f.recommendation==='buy'||f.recommendation==='strong_buy'?'var(--green)':f.recommendation==='sell'?'var(--red)':'var(--yellow)'),
  ].join('');
}

function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b=>{
    if(b.textContent.toLowerCase().includes(tab.substring(0,4))) b.classList.add('active');
  });
}

async function loadHistory(){
  try {
    const r = await fetch('/api/history');
    const data = await r.json();
    const list = document.getElementById('historyList');
    const searches = data.searches || [];

    if(!searches.length){
      list.innerHTML = '<div class="empty-history">No searches yet</div>';
      return;
    }

    list.innerHTML = searches.slice(0,50).map(h=>{
      const col = h.score>=70?'var(--green)':h.score>=55?'var(--yellow)':'var(--red)';
      return `<div class="history-item" onclick="searchTicker('${h.ticker}')">
        <span class="hi-ticker">${h.ticker}</span>
        <span class="hi-score" style="color:${col}">${Math.round(h.score)}</span>
        <span class="hi-trade ${tsClass(h.trade_signal)}" style="font-size:8px;padding:1px 5px;border-radius:3px;">${h.trade_signal||h.signal}</span>
        <span class="hi-price">$${h.price?h.price.toFixed(2):'—'}</span>
      </div>`;
    }).join('');
  } catch(e) {
    // API not available, use empty state
  }
}

function searchTicker(ticker){
  document.getElementById('tickerInput').value = ticker;
  doSearch();
}

async function clearHistory(){
  try {
    await fetch('/api/history', {method:'DELETE'});
    loadHistory();
  } catch(e){}
}

// Load history on page load
loadHistory();
</script>
</body>
</html>
