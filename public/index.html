<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Pulse Dashboard â€” Live</title>
<style>
  :root {
    --bg:#0d1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;
    --text:#e6edf3;--dim:#8b949e;--green:#3fb950;--red:#f85149;
    --yellow:#d29922;--blue:#58a6ff;--purple:#bc8cff;--orange:#f0883e;--cyan:#39d2c0;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.5;}
  a{color:var(--blue);text-decoration:none;}a:hover{text-decoration:underline;}

  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;}
  .header h1{font-size:20px;font-weight:600;} .header h1 span{color:var(--blue);}
  .header-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  .btn{border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;gap:5px;transition:all .15s;}
  .btn-primary{background:var(--blue);color:#fff;}.btn-primary:hover{filter:brightness(1.15);}
  .btn.spinning svg{animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
  .ts{font-size:11px;color:var(--dim);padding:3px 28px;}

  /* Index ticker bar */
  .index-bar{display:flex;gap:0;padding:0 28px;border-bottom:1px solid var(--border);background:var(--surface);overflow-x:auto;}
  .idx{padding:10px 18px;border-right:1px solid var(--border);min-width:140px;flex-shrink:0;}
  .idx:last-child{border-right:none;}
  .idx-name{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;font-weight:700;}
  .idx-level{font-size:16px;font-weight:700;font-family:'SF Mono','Fira Code',monospace;margin:2px 0;}
  .idx-change{font-size:11px;font-family:'SF Mono',monospace;display:flex;gap:8px;}
  .idx-ytd{font-size:10px;color:var(--dim);margin-top:1px;}

  .nav{padding:12px 28px;display:flex;gap:8px;border-bottom:1px solid var(--border);}
  .nav a{padding:6px 14px;border-radius:6px;font-size:13px;font-weight:500;color:var(--dim);transition:all .15s;}
  .nav a:hover{background:var(--surface2);color:var(--text);text-decoration:none;}
  .nav a.active{background:var(--blue);color:#fff;}

  .controls{padding:14px 28px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  .pill{background:var(--surface2);border:1px solid var(--border);color:var(--dim);padding:5px 12px;border-radius:20px;cursor:pointer;font-size:11px;transition:all .15s;}
  .pill:hover,.pill.on{background:var(--blue);color:#fff;border-color:var(--blue);}
  .pill.breaker-on{background:var(--red);color:#fff;border-color:var(--red);}
  .search{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:6px;font-size:12px;width:200px;}
  .search::placeholder{color:var(--dim);}.search:focus{outline:none;border-color:var(--blue);}
  .auto-label{font-size:11px;color:var(--dim);margin-left:auto;display:flex;align-items:center;gap:6px;}
  .countdown{font-family:'SF Mono','Fira Code',monospace;font-size:11px;color:var(--cyan);min-width:28px;text-align:center;}
  .toggle{position:relative;width:36px;height:20px;background:var(--surface2);border-radius:10px;cursor:pointer;border:1px solid var(--border);}
  .toggle.on{background:var(--blue);border-color:var(--blue);}
  .toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:#fff;transition:.2s;}
  .toggle.on::after{left:18px;}
  .flash{animation:flashGreen .6s ease;}
  @keyframes flashGreen{0%{background:rgba(63,185,80,.2);}100%{background:transparent;}}
  .stale-banner{background:rgba(248,81,73,.1);border:1px solid var(--red);border-radius:6px;padding:8px 16px;margin:8px 28px;font-size:12px;color:var(--red);display:none;align-items:center;gap:8px;}
  .stale-banner.show{display:flex;}

  /* Dashboard view toggle */
  .view-toggle{display:flex;gap:0;background:var(--surface2);border-radius:6px;border:1px solid var(--border);overflow:hidden;}
  .view-btn{padding:5px 14px;font-size:11px;font-weight:600;color:var(--dim);cursor:pointer;border:none;background:none;transition:.15s;}
  .view-btn:hover{color:var(--text);}
  .view-btn.active{background:var(--blue);color:#fff;}

  .grid{padding:0 28px 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;}
  .stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px;}
  .stat .l{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;}
  .stat .v{font-size:22px;font-weight:700;}.stat .s{font-size:11px;color:var(--dim);margin-top:1px;}

  /* Charts row */
  .charts-row{padding:0 28px 16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .chart-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;overflow:hidden;}
  .chart-card h3{font-size:13px;font-weight:600;margin-bottom:12px;color:var(--text);}

  /* Bar chart */
  .bar-chart{display:flex;flex-direction:column;gap:6px;}
  .bar-row{display:flex;align-items:center;gap:8px;}
  .bar-label{font-size:10px;color:var(--dim);width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0;text-align:right;}
  .bar-track{flex:1;height:18px;background:var(--surface2);border-radius:3px;position:relative;overflow:hidden;}
  .bar-fill2{height:100%;border-radius:3px;transition:width .3s;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;}
  .bar-val{font-size:10px;font-weight:700;color:#fff;white-space:nowrap;}

  /* Pie chart */
  .pie-container{display:flex;align-items:center;gap:24px;justify-content:center;}
  .pie-legend{display:flex;flex-direction:column;gap:6px;}
  .pie-legend-item{display:flex;align-items:center;gap:8px;font-size:12px;}
  .pie-swatch{width:12px;height:12px;border-radius:2px;flex-shrink:0;}

  /* Heatmap */
  .heatmap-section{padding:0 28px 16px;}
  .heatmap-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;overflow:hidden;}
  .heatmap-card h3{font-size:13px;font-weight:600;margin-bottom:4px;}
  .heatmap-card .subtitle{font-size:11px;color:var(--dim);margin-bottom:12px;}
  .heatmap-grid{display:flex;flex-wrap:wrap;gap:3px;}
  .hm-tile{border-radius:4px;padding:4px 6px;cursor:pointer;transition:all .15s;text-align:center;min-width:52px;border:1px solid transparent;}
  .hm-tile:hover{border-color:var(--blue);transform:scale(1.05);z-index:2;}
  .hm-ticker{font-size:10px;font-weight:700;font-family:'SF Mono',monospace;color:#fff;}
  .hm-score{font-size:9px;font-weight:600;color:rgba(255,255,255,.8);}
  .hm-group-label{width:100%;font-size:11px;font-weight:600;color:var(--cyan);margin:8px 0 4px;padding-bottom:4px;border-bottom:1px solid var(--border);cursor:pointer;}
  .hm-group-label:first-child{margin-top:0;}
  .hm-group-label:hover{color:var(--blue);text-decoration:underline;}

  /* Tooltip */
  .tooltip{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:11px;z-index:100;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,.5);max-width:260px;}
  .tooltip .tt-ticker{font-size:14px;font-weight:700;color:var(--blue);font-family:'SF Mono',monospace;}
  .tooltip .tt-row{display:flex;justify-content:space-between;gap:16px;margin-top:3px;}
  .tooltip .tt-label{color:var(--dim);}

  .main{padding:0 28px 28px;}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:12px;overflow:hidden;transition:border-color .2s;}
  .card.breaker-critical{border-color:var(--red);}
  .card.breaker-warning{border-color:var(--orange);}
  .card.breaker-watch{border-color:var(--yellow);}
  .card-head{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:.15s;}
  .card-head:hover{background:var(--surface2);}
  .card-head.open{border-bottom:1px solid var(--border);}
  .g-left{display:flex;align-items:center;gap:12px;}
  .rank{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;background:var(--surface2);color:var(--dim);}
  .rank.top{background:var(--blue);color:#fff;}
  .g-name{font-size:15px;font-weight:600;}
  .g-meta{font-size:11px;color:var(--dim);}
  .g-gics{font-size:10px;color:var(--cyan);font-family:'SF Mono','Fira Code',monospace;}
  .g-right{display:flex;align-items:center;gap:12px;}
  .g-ytd{font-size:17px;font-weight:700;color:var(--green);}
  .sig-badge{padding:3px 10px;border-radius:4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
  .sig-strong-buy{background:rgba(63,185,80,.18);color:var(--green);}
  .sig-buy{background:rgba(63,185,80,.1);color:var(--green);}
  .sig-hold{background:rgba(210,153,34,.15);color:var(--yellow);}
  .sig-sell{background:rgba(248,81,73,.12);color:var(--red);}
  .sig-strong-sell{background:rgba(248,81,73,.2);color:var(--red);}
  .breaker-badge{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.3px;}
  .breaker-critical{background:rgba(248,81,73,.18);color:var(--red);}
  .breaker-warning{background:rgba(240,136,62,.15);color:var(--orange);}
  .breaker-watch{background:rgba(210,153,34,.12);color:var(--yellow);}
  .breaker-clear{background:rgba(63,185,80,.1);color:var(--green);}
  .chev{transition:transform .2s;color:var(--dim);}.chev.open{transform:rotate(180deg);}

  .card-body{display:none;}.card-body.open{display:block;}

  .info-panel{padding:14px 18px;background:var(--surface2);border-bottom:1px solid var(--border);}
  .thesis-text{font-size:12px;color:var(--dim);line-height:1.7;margin-bottom:8px;}
  .thesis-breaker-text{font-size:11px;color:var(--red);padding:6px 10px;background:rgba(248,81,73,.06);border-left:3px solid var(--red);border-radius:0 4px 4px 0;margin-bottom:10px;}
  .breaker-panel{margin-top:8px;}
  .breaker-panel-header{font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:flex;align-items:center;gap:8px;}
  .breaker-item{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px;}
  .breaker-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .breaker-dot.critical{background:var(--red);}
  .breaker-dot.high{background:var(--orange);}
  .breaker-dot.medium{background:var(--yellow);}
  .breaker-dot.clear{background:var(--green);opacity:.5;}
  .breaker-msg{color:var(--text);}
  .breaker-msg.clear{color:var(--dim);}

  .tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--surface);}
  .tab-btn{padding:8px 16px;font-size:11px;font-weight:600;color:var(--dim);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:.15s;}
  .tab-btn:hover{color:var(--text);}
  .tab-btn.active{color:var(--blue);border-bottom-color:var(--blue);}
  .tab-content{display:none;}.tab-content.active{display:block;}

  table{width:100%;border-collapse:collapse;}
  th{text-align:left;padding:7px 10px;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;background:var(--surface);border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;user-select:none;}
  th:hover{color:var(--blue);}
  td{padding:7px 10px;font-size:11px;border-bottom:1px solid var(--border);white-space:nowrap;}
  tr:last-child td{border-bottom:none;}
  tr:hover td{background:rgba(88,166,255,.03);}
  .tk{font-weight:700;color:var(--blue);font-family:'SF Mono','Fira Code',monospace;font-size:11px;text-decoration:none;cursor:pointer;}.tk:hover{text-decoration:underline;filter:brightness(1.2);}
  .hm-ticker a{color:#fff;text-decoration:none;}.hm-ticker a:hover{text-decoration:underline;}
  .sp{background:rgba(188,140,255,.15);color:var(--purple);font-size:9px;padding:1px 5px;border-radius:3px;font-weight:600;margin-left:4px;}
  .ytd{font-weight:600;font-family:'SF Mono',monospace;font-size:11px;}
  .ytd.up{color:var(--green);}.ytd.dn{color:var(--red);}
  .dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:4px;}
  .dot.buy,.dot.strong-buy{background:var(--green);}.dot.hold{background:var(--yellow);}.dot.sell,.dot.strong-sell{background:var(--red);}
  .bar{display:flex;height:5px;border-radius:3px;width:60px;background:var(--surface2);}
  .bar-fill{height:100%;border-radius:3px;}
  .mono{font-family:'SF Mono','Fira Code',monospace;font-size:11px;}
  .rec{padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700;text-transform:uppercase;}
  .rec-buy,.rec-strong_buy{background:rgba(63,185,80,.12);color:var(--green);}
  .rec-hold{background:rgba(210,153,34,.1);color:var(--yellow);}
  .rec-sell,.rec-strong_sell,.rec-underperform{background:rgba(248,81,73,.1);color:var(--red);}

  /* Trade signal badges */
  .ts-badge{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.3px;white-space:nowrap;}
  .ts-buy-now{background:rgba(63,185,80,.2);color:#3fb950;border:1px solid rgba(63,185,80,.3);}
  .ts-wait{background:rgba(210,153,34,.15);color:#d29922;border:1px solid rgba(210,153,34,.25);}
  .ts-accumulate{background:rgba(88,166,255,.12);color:#58a6ff;border:1px solid rgba(88,166,255,.25);}
  .ts-hold{background:rgba(139,148,158,.1);color:#8b949e;border:1px solid rgba(139,148,158,.2);}
  .ts-reduce{background:rgba(240,136,62,.15);color:#f0883e;border:1px solid rgba(240,136,62,.25);}
  .ts-avoid{background:rgba(248,81,73,.18);color:#f85149;border:1px solid rgba(248,81,73,.3);}
  .reasoning{font-size:10px;color:var(--dim);max-width:300px;white-space:normal;line-height:1.4;}

  /* Stage badges */
  .stg{padding:2px 7px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:.3px;white-space:nowrap;}
  .stg-1{background:rgba(88,166,255,.12);color:#58a6ff;}
  .stg-2{background:rgba(63,185,80,.15);color:#3fb950;}
  .stg-3{background:rgba(240,136,62,.12);color:#f0883e;}
  .stg-4{background:rgba(248,81,73,.15);color:#f85149;}
  .stg-0{background:rgba(139,148,158,.08);color:#8b949e;}

  .legend{padding:14px 28px;display:flex;gap:20px;flex-wrap:wrap;font-size:11px;color:var(--dim);border-top:1px solid var(--border);margin-top:12px;}
  .legend-i{display:flex;align-items:center;gap:5px;}
  .empty{text-align:center;padding:60px;color:var(--dim);}
  .empty h2{font-size:18px;margin-bottom:8px;color:var(--text);}
  .loader{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;}
  .tbl-scroll{overflow-x:auto;}

  @media(max-width:768px){.header,.nav,.controls,.main,.grid,.charts-row,.heatmap-section{padding-left:14px;padding-right:14px;}.g-right{flex-direction:column;align-items:flex-end;gap:4px;}.grid{grid-template-columns:1fr 1fr;}.charts-row{grid-template-columns:1fr;}.index-bar{padding:0 14px;}}
</style>
</head>
<body>

<div class="header">
  <h1><span>&#9679;</span> Market <span>Pulse</span> Dashboard</h1>
  <div class="header-right">
    <div style="display:flex;align-items:center;gap:6px;"><div class="live-dot"></div><span style="font-size:11px;color:var(--green)">Live</span></div>
    <button class="btn btn-primary" id="refreshBtn" onclick="manualRefresh()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      Refresh
    </button>
  </div>
</div>

<!-- Index ticker bar -->
<div class="index-bar" id="indexBar">
  <div class="idx"><div class="idx-name">Loading indexes...</div></div>
</div>

<div class="ts" id="tsLine"></div>
<div class="stale-banner" id="staleBanner">&#9888; Data is stale â€” signal engine hasn't run recently. Pipeline runs every 15 min during market hours (Monâ€“Fri 9:30 AM â€“ 4:30 PM ET).</div>

<div class="nav">
  <a href="index.html" class="active">Dashboard</a>
  <a href="search.html">Ticker Search</a>
  <a href="sentiment.html">Sentiment</a>
  <a href="feargreed.html">Fear & Greed</a>
  <a href="history.html">History &amp; Changes</a>
  <a href="architecture.html">Architecture</a>
</div>

<div class="controls">
  <button class="pill on" onclick="filt('all',this)">All</button>
  <button class="pill" onclick="filt('strong-buy',this)">Strong Buy</button>
  <button class="pill" onclick="filt('buy',this)">Buy</button>
  <button class="pill" onclick="filt('hold',this)">Hold</button>
  <button class="pill" onclick="filt('sell',this)">Sell</button>
  <button class="pill" id="breakerFilter" onclick="filtBreaker(this)">Breaker Alerts Only</button>
  <input class="search" type="text" placeholder="Search ticker or group..." oninput="search(this.value)">
  <div class="view-toggle">
    <button class="view-btn active" onclick="setView('overview',this)">Overview</button>
    <button class="view-btn" onclick="setView('groups',this)">Groups</button>
  </div>
  <div class="auto-label">
    Auto-refresh <span class="countdown" id="countdown">15m</span>
    <div class="toggle on" id="autoToggle" onclick="toggleAuto()"></div>
  </div>
</div>

<div class="grid" id="statsGrid"></div>

<!-- Overview: Heatmap + Charts (shown by default) -->
<div id="overviewSection">
  <div class="heatmap-section">
    <div class="heatmap-card">
      <h3>Signal Heatmap</h3>
      <div class="subtitle">All tickers colored by score. Click any group to drill down.</div>
      <div class="heatmap-grid" id="heatmapGrid"></div>
    </div>
  </div>
  <div class="charts-row">
    <div class="chart-card">
      <h3>Group Avg YTD Return (%)</h3>
      <div id="barChart" class="bar-chart"></div>
    </div>
    <div class="chart-card">
      <h3>Signal Distribution</h3>
      <div id="pieChart" class="pie-container"></div>
    </div>
  </div>
</div>

<!-- Groups detail view -->
<div class="main" id="mainContent" style="display:none;"><div class="empty"><div class="loader"></div><p style="margin-top:12px">Loading signals...</p></div></div>

<div class="legend">
  <div class="legend-i"><div class="dot strong-buy"></div>Strong Buy</div>
  <div class="legend-i"><div class="dot buy"></div>Buy</div>
  <div class="legend-i"><div class="dot hold"></div>Hold</div>
  <div class="legend-i"><div class="dot sell"></div>Sell</div>
  <div class="legend-i"><span class="sp">S&P</span> Beating S&P 500</div>
  <div class="legend-i"><span style="color:var(--red)">&#9679;</span> Thesis Breaker Active</div>
</div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip" style="display:none;"></div>

<script>
let DATA = null;
let prevTimestamp = null;
let filter = 'all';
let query = '';
let breakerOnly = false;
let autoRefresh = true;
let countdownSec = 900;
let countdownTimer = null;
let currentView = 'overview';
const REFRESH_INTERVAL = 900; // 15 minutes in seconds
let refreshInProgress = false;

function tvUrl(ticker){return `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(ticker)}`;}
function tvLink(ticker,cls){return `<a href="${tvUrl(ticker)}" target="_blank" rel="noopener" class="${cls||'tk'}" title="Open ${ticker} in TradingView" onclick="event.stopPropagation()">${ticker}</a>`;}
function scoreColor(s){return s>=70?'var(--green)':s>=55?'var(--yellow)':'var(--red)';}
function scoreHex(s){return s>=70?'#3fb950':s>=55?'#d29922':'#f85149';}
function scoreBg(s){
  if(s>=80) return '#1a6334';
  if(s>=70) return '#1e5a2a';
  if(s>=60) return '#5a4a10';
  if(s>=50) return '#6b4b0a';
  if(s>=40) return '#6e3a0a';
  return '#6e1a1a';
}
function sigClass(s){return 'sig-'+(s||'hold');}
function fmtMcap(v){if(!v)return 'â€”';if(v>=1e12)return '$'+(v/1e12).toFixed(1)+'T';if(v>=1e9)return '$'+(v/1e9).toFixed(1)+'B';if(v>=1e6)return '$'+(v/1e6).toFixed(0)+'M';return '$'+v;}
function fmtPct(v){if(v===null||v===undefined)return 'â€”';return (v*100).toFixed(1)+'%';}
function fmtNum(v,d){if(v===null||v===undefined)return 'â€”';return Number(v).toFixed(d||1);}
function fmtComma(v){return v?v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):'â€”';}
function breakerIcon(status){return {critical:'ðŸ”´',warning:'ðŸŸ ',watch:'ðŸŸ¡',clear:'ðŸŸ¢'}[status]||'âšª';}
function tsClass(ts){
  if(!ts) return 'ts-hold';
  const t = ts.toUpperCase();
  if(t==='BUY NOW') return 'ts-buy-now';
  if(t.includes('WAIT')) return 'ts-wait';
  if(t.includes('ACCUMULATE')) return 'ts-accumulate';
  if(t.includes('HOLD')) return 'ts-hold';
  if(t.includes('REDUCE')) return 'ts-reduce';
  if(t==='AVOID') return 'ts-avoid';
  return 'ts-hold';
}
function stgBadge(s){
  if(!s||!s.stage) return '<span class="stg stg-0">â€”</span>';
  const names={1:'S1 Base',2:'S2 Adv',3:'S3 Top',4:'S4 Dec'};
  return `<span class="stg stg-${s.stage}" title="${s.stage_name}: ${s.description}">${names[s.stage]||'â€”'}</span>`;
}

async function loadData(){
  try{
    const r = await fetch('signals.json?t='+Date.now());
    if(!r.ok) throw new Error('No signals.json');
    const newData = await r.json();
    const dataChanged = prevTimestamp && newData.timestamp !== prevTimestamp;
    prevTimestamp = newData.timestamp;
    DATA = newData;
    render();
    if(dataChanged){
      document.getElementById('statsGrid').classList.add('flash');
      setTimeout(()=>document.getElementById('statsGrid').classList.remove('flash'),700);
      document.title = 'ðŸ”„ NEW DATA â€” Market Pulse Dashboard';
      setTimeout(()=>{document.title='Market Pulse Dashboard â€” Live';},5000);
    }
  }catch(e){
    document.getElementById('mainContent').style.display='block';
    document.getElementById('overviewSection').style.display='none';
    document.getElementById('mainContent').innerHTML = `<div class="empty"><h2>No Live Data Yet</h2><p>Run the signal engine first:<br><code style="background:var(--surface2);padding:4px 8px;border-radius:4px;font-size:13px">python signal_engine.py && python history_manager.py</code></p></div>`;
  }
}

function updateTimestampDisplay(){
  if(!DATA) return;
  const genTime = new Date(DATA.timestamp);
  const now = new Date();
  const ageMs = now - genTime;
  const ageMin = Math.floor(ageMs / 60000);
  const ageStr = ageMin < 60 ? `${ageMin}m ago` : ageMin < 1440 ? `${Math.floor(ageMin/60)}h ${ageMin%60}m ago` : `${Math.floor(ageMin/1440)}d ago`;
  const stale = ageMin > 30;
  document.getElementById('tsLine').innerHTML = `Data generated: ${genTime.toLocaleString()} <span style="color:${stale?'var(--red)':'var(--green)'}; margin-left:8px;">(${ageStr})</span>`;
  const banner = document.getElementById('staleBanner');
  if(stale){banner.classList.add('show');}else{banner.classList.remove('show');}
}

function renderIndexBar(){
  const indexes = DATA.indexes || {};
  const order = ['^GSPC','^IXIC','^DJI','^RUT','^VIX'];
  let html = '';
  order.forEach(sym=>{
    const idx = indexes[sym];
    if(!idx) return;
    const isVix = sym === '^VIX';
    const up = isVix ? idx.day_change <= 0 : idx.day_change >= 0;
    const col = up ? 'var(--green)' : 'var(--red)';
    const arrow = idx.day_change >= 0 ? 'â–²' : 'â–¼';
    const ytdUp = isVix ? idx.ytd <= 0 : idx.ytd >= 0;
    html += `<div class="idx">
      <div class="idx-name">${idx.name}</div>
      <div class="idx-level">${fmtComma(idx.level)}</div>
      <div class="idx-change">
        <span style="color:${col}">${arrow} ${Math.abs(idx.day_change).toFixed(2)}</span>
        <span style="color:${col}">(${idx.day_change_pct >= 0 ? '+' : ''}${idx.day_change_pct}%)</span>
      </div>
      <div class="idx-ytd">YTD: <span style="color:${ytdUp?'var(--green)':'var(--red)'}">${idx.ytd >= 0 ? '+' : ''}${idx.ytd}%</span></div>
    </div>`;
  });
  document.getElementById('indexBar').innerHTML = html || '<div class="idx"><div class="idx-name">No index data</div></div>';
}

function renderHeatmap(){
  const groups = DATA.groups||[];
  let html = '';
  groups.forEach((g,gi)=>{
    if(filter!=='all' && g.group_signal!==filter) return;
    if(breakerOnly && (!g.breaker_status || g.breaker_status==='clear')) return;
    const stocks = query ? g.stocks.filter(s=>s.ticker.toLowerCase().includes(query)||g.name.toLowerCase().includes(query)) : g.stocks;
    if(query && !stocks.length && !g.name.toLowerCase().includes(query)) return;

    html += `<div class="hm-group-label" onclick="drillToGroup(${gi})">#${g.rank} ${g.name} (${g.avg_ytd>=0?'+':''}${g.avg_ytd}%) ${breakerIcon(g.breaker_status||'clear')}</div>`;
    stocks.forEach(s=>{
      const stgLbl = s.stage_analysis ? 'S'+s.stage_analysis.stage+' '+s.stage_analysis.stage_name : 'â€”';
      html += `<div class="hm-tile" style="background:${scoreBg(s.score)}" onmouseenter="showTT(event,this)" onmouseleave="hideTT()" data-ticker="${s.ticker}" data-score="${s.score}" data-signal="${s.signal}" data-ytd="${s.ytd_return}" data-price="${s.price?s.price.toFixed(2):'â€”'}" data-rsi="${fmtNum(s.rsi,1)}" data-group="${g.name}" data-trade="${s.trade_signal||'â€”'}" data-stage="${stgLbl}">
        <div class="hm-ticker"><a href="${tvUrl(s.ticker)}" target="_blank" rel="noopener" title="Open in TradingView">${s.ticker}</a></div>
        <div class="hm-score">${s.score}</div>
      </div>`;
    });
  });
  document.getElementById('heatmapGrid').innerHTML = html || '<div style="padding:20px;color:var(--dim)">No data</div>';
}

function renderBarChart(){
  const groups = DATA.groups||[];
  const filtered = groups.filter(g=>{
    if(filter!=='all' && g.group_signal!==filter) return false;
    if(breakerOnly && (!g.breaker_status || g.breaker_status==='clear')) return false;
    if(query && !g.name.toLowerCase().includes(query)) return false;
    return true;
  });
  const maxYtd = Math.max(...filtered.map(g=>Math.abs(g.avg_ytd)),1);
  let html = '';
  filtered.forEach(g=>{
    const pct = Math.abs(g.avg_ytd)/maxYtd*100;
    const col = g.avg_ytd >= 0 ? 'var(--green)' : 'var(--red)';
    html += `<div class="bar-row">
      <div class="bar-label" title="${g.name}">${g.name}</div>
      <div class="bar-track"><div class="bar-fill2" style="width:${pct}%;background:${col}"><span class="bar-val">${g.avg_ytd>=0?'+':''}${g.avg_ytd}%</span></div></div>
    </div>`;
  });
  document.getElementById('barChart').innerHTML = html;
}

function renderPieChart(){
  const groups = DATA.groups||[];
  let counts = {'strong-buy':0, buy:0, hold:0, sell:0, 'strong-sell':0};
  groups.forEach(g=>{
    g.stocks.forEach(s=>{
      if(counts[s.signal] !== undefined) counts[s.signal]++;
    });
  });
  const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
  const colors = {'strong-buy':'#2ea043','buy':'#3fb950','hold':'#d29922','sell':'#f85149','strong-sell':'#da3633'};
  const labels = {'strong-buy':'Strong Buy','buy':'Buy','hold':'Hold','sell':'Sell','strong-sell':'Strong Sell'};

  // SVG pie
  let cumulativePercent = 0;
  let paths = '';
  const entries = Object.entries(counts).filter(([,v])=>v>0);

  if(entries.length === 0){
    document.getElementById('pieChart').innerHTML = '<div style="color:var(--dim);padding:20px;">No data</div>';
    return;
  }

  entries.forEach(([signal,count])=>{
    const percent = count/total;
    const startAngle = cumulativePercent * 2 * Math.PI;
    cumulativePercent += percent;
    const endAngle = cumulativePercent * 2 * Math.PI;
    const largeArc = percent > 0.5 ? 1 : 0;
    const x1 = 80 + 70 * Math.cos(startAngle - Math.PI/2);
    const y1 = 80 + 70 * Math.sin(startAngle - Math.PI/2);
    const x2 = 80 + 70 * Math.cos(endAngle - Math.PI/2);
    const y2 = 80 + 70 * Math.sin(endAngle - Math.PI/2);

    if(entries.length === 1){
      paths += `<circle cx="80" cy="80" r="70" fill="${colors[signal]}"/>`;
    } else {
      paths += `<path d="M80,80 L${x1},${y1} A70,70 0 ${largeArc},1 ${x2},${y2} Z" fill="${colors[signal]}"/>`;
    }
  });

  let legendHtml = '';
  entries.forEach(([signal,count])=>{
    const pct = ((count/total)*100).toFixed(0);
    legendHtml += `<div class="pie-legend-item"><div class="pie-swatch" style="background:${colors[signal]}"></div><span>${labels[signal]}: ${count} (${pct}%)</span></div>`;
  });

  document.getElementById('pieChart').innerHTML = `
    <svg width="160" height="160" viewBox="0 0 160 160">${paths}</svg>
    <div class="pie-legend">${legendHtml}</div>
  `;
}

function render(){
  if(!DATA) return;
  renderIndexBar();
  updateTimestampDisplay();

  const groups = DATA.groups||[];
  const totalStocks = groups.reduce((a,g)=>a+g.stock_count,0);
  const buys = groups.reduce((a,g)=>a+g.stocks.filter(s=>s.signal==='buy'||s.signal==='strong-buy').length,0);
  const sells = groups.reduce((a,g)=>a+g.stocks.filter(s=>s.signal==='sell'||s.signal==='strong-sell').length,0);
  const avgScore = groups.length ? Math.round(groups.reduce((a,g)=>a+g.avg_score,0)/groups.length) : 0;
  const breakerCount = groups.filter(g=>g.breaker_status && g.breaker_status!=='clear').length;

  document.getElementById('statsGrid').innerHTML = `
    <div class="stat"><div class="l">Groups Tracked</div><div class="v">${groups.length}</div></div>
    <div class="stat"><div class="l">Total Tickers</div><div class="v">${totalStocks}</div></div>
    <div class="stat"><div class="l">Buy Signals</div><div class="v" style="color:var(--green)">${buys}</div></div>
    <div class="stat"><div class="l">Sell Signals</div><div class="v" style="color:var(--red)">${sells}</div></div>
    <div class="stat"><div class="l">Avg Score</div><div class="v" style="color:${scoreColor(avgScore)}">${avgScore}</div></div>
    <div class="stat"><div class="l">Breaker Alerts</div><div class="v" style="color:${breakerCount>0?'var(--red)':'var(--green)'}">${breakerCount>0?breakerCount+' âš ':'0 âœ“'}</div></div>
  `;

  renderHeatmap();
  renderBarChart();
  renderPieChart();
  renderGroups();

  // Show correct view
  if(currentView === 'overview'){
    document.getElementById('overviewSection').style.display='';
    document.getElementById('mainContent').style.display='none';
  } else {
    document.getElementById('overviewSection').style.display='none';
    document.getElementById('mainContent').style.display='';
  }
}

function renderGroups(){
  const groups = DATA.groups||[];
  let html = '';
  groups.forEach((g,i)=>{
    if(filter!=='all' && g.group_signal!==filter) return;
    if(breakerOnly && (!g.breaker_status || g.breaker_status==='clear')) return;
    const stocks = query ? g.stocks.filter(s=>s.ticker.toLowerCase().includes(query)||g.name.toLowerCase().includes(query)) : g.stocks;
    if(query && !stocks.length && !g.name.toLowerCase().includes(query)) return;

    const bs = g.breaker_status||'clear';
    const triggeredAlerts = (g.breaker_alerts||[]).filter(a=>a.triggered);

    html += `<div class="card ${bs!=='clear'?'breaker-'+bs:''}" id="group-card-${i}"><div class="card-head" onclick="tog(${i})">
      <div class="g-left"><div class="rank ${g.rank<=3?'top':''}">${g.rank}</div>
        <div>
          <div class="g-name">${g.name} ${bs!=='clear'?breakerIcon(bs):''}</div>
          <div class="g-meta">${g.sector} Â· ${g.industry_group||''} Â· ${g.beating_sp500_count}/${g.stock_count} beating S&P Â· ${g.cycle_stage} cycle</div>
          <div class="g-gics">GICS ${g.gics_code||''} Â· ${g.gics_level||''}</div>
        </div>
      </div>
      <div class="g-right">
        <div class="g-ytd" style="color:${g.avg_ytd>=0?'var(--green)':'var(--red)'}">${g.avg_ytd>=0?'+':''}${g.avg_ytd}%</div>
        <div class="sig-badge ${sigClass(g.group_signal)}">${g.group_signal.replace('-',' ')}</div>
        <span class="breaker-badge breaker-${bs}">${bs.toUpperCase()}</span>
        <svg class="chev" id="ch${i}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
    </div>
    <div class="card-body" id="bd${i}">
      <div class="info-panel">
        <div class="thesis-text"><strong>Thesis:</strong> ${g.thesis}</div>
        <div class="thesis-breaker-text"><strong>THESIS BREAKER:</strong> ${g.thesis_breaker}</div>
        ${triggeredAlerts.length>0||g.breaker_alerts?`
        <div class="breaker-panel">
          <div class="breaker-panel-header">${breakerIcon(bs)} Breaker Monitor â€” ${bs.toUpperCase()}</div>
          ${(g.breaker_alerts||[]).map(a=>`
            <div class="breaker-item">
              <div class="breaker-dot ${a.triggered?a.severity:'clear'}"></div>
              <span class="breaker-msg ${a.triggered?'':'clear'}">${a.triggered?a.message:a.description+' â€” OK'}</span>
            </div>
          `).join('')}
        </div>`:''}
      </div>
      <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab(${i},'signals')">Signals & Technicals</button>
        <button class="tab-btn" onclick="switchTab(${i},'momentum')">Momentum</button>
        <button class="tab-btn" onclick="switchTab(${i},'fundamentals')">Fundamentals</button>
      </div>
      <div class="tab-content active" id="tab-signals-${i}">
        <div class="tbl-scroll"><table><thead><tr>
          <th onclick="sortG(${i},'ticker')">Ticker</th><th onclick="sortG(${i},'price')">Price</th><th onclick="sortG(${i},'ytd_return')">YTD %</th><th onclick="sortG(${i},'score')">Score</th><th>Signal</th><th>Stage</th><th>Trade Signal</th><th onclick="sortG(${i},'rsi')">RSI</th><th>MACD</th><th>Price vs MA</th><th onclick="sortG(${i},'volume_ratio')">Vol</th><th>Reasoning</th>
        </tr></thead><tbody>
        ${(query?stocks:g.stocks).map(s=>`<tr>
          <td>${tvLink(s.ticker)}${s.beating_sp500?'<span class="sp">S&Pâœ“</span>':''}</td>
          <td class="mono" style="font-weight:600">$${s.price?s.price.toFixed(2):'â€”'}</td>
          <td class="ytd ${s.ytd_return>=0?'up':'dn'}">${s.ytd_return>=0?'+':''}${s.ytd_return}%</td>
          <td><div style="display:flex;align-items:center;gap:6px"><div class="bar"><div class="bar-fill" style="width:${s.score}%;background:${scoreColor(s.score)}"></div></div><span style="font-size:11px;font-weight:600;color:${scoreColor(s.score)}">${s.score}</span></div></td>
          <td><div class="dot ${s.signal}"></div><span style="font-size:11px;font-weight:600;color:${scoreColor(s.score)}">${s.signal.toUpperCase()}</span></td>
          <td>${stgBadge(s.stage_analysis)}</td>
          <td><span class="ts-badge ${tsClass(s.trade_signal)}">${s.trade_signal||'â€”'}</span></td>
          <td style="color:${s.rsi>70?'var(--red)':s.rsi<30?'var(--green)':'var(--dim)'}" class="mono">${fmtNum(s.rsi,1)}</td>
          <td style="color:${s.macd_histogram>0?'var(--green)':'var(--red)'}" class="mono">${s.macd_histogram>0?'â–²':'â–¼'} ${Math.abs(s.macd_histogram||0).toFixed(2)}</td>
          <td style="font-size:11px;">${s.price>s.ma50?'<span style="color:var(--green)">â–²MA50</span>':'<span style="color:var(--red)">â–¼MA50</span>'}${s.ma200!=null?(s.price>s.ma200?' <span style="color:var(--green)">â–²200</span>':' <span style="color:var(--red)">â–¼200</span>'):''}</td>
          <td style="color:${s.volume_ratio>1.2?'var(--green)':s.volume_ratio<0.8?'var(--red)':'var(--dim)'}" class="mono">${s.volume_ratio||1}x</td>
          <td class="reasoning">${s.trade_reasoning||'â€”'}</td>
        </tr>`).join('')}
        </tbody></table></div>
      </div>
      <div class="tab-content" id="tab-momentum-${i}">
        <div class="tbl-scroll"><table><thead><tr>
          <th onclick="sortG(${i},'ticker')">Ticker</th><th onclick="sortG(${i},'price')">Price</th><th onclick="sortG(${i},'return_1m')">1M Ret</th><th onclick="sortG(${i},'return_3m')">3M Ret</th><th onclick="sortG(${i},'ytd_return')">YTD</th><th onclick="sortG(${i},'pct_from_52w_high')">% From 52W Hi</th><th>52W Range</th><th onclick="sortG(${i},'rs_vs_ma50')">RS vs MA50</th><th onclick="sortG(${i},'trend_strength')">Trend Str</th><th>Signal</th>
        </tr></thead><tbody>
        ${(query?stocks:g.stocks).map(s=>`<tr>
          <td>${tvLink(s.ticker)}</td>
          <td class="mono" style="font-weight:600">$${s.price?s.price.toFixed(2):'â€”'}</td>
          <td class="mono" style="color:${(s.return_1m||0)>=0?'var(--green)':'var(--red)'}">${(s.return_1m||0)>=0?'+':''}${fmtNum(s.return_1m,1)}%</td>
          <td class="mono" style="color:${(s.return_3m||0)>=0?'var(--green)':'var(--red)'}">${(s.return_3m||0)>=0?'+':''}${fmtNum(s.return_3m,1)}%</td>
          <td class="ytd ${s.ytd_return>=0?'up':'dn'}">${s.ytd_return>=0?'+':''}${s.ytd_return}%</td>
          <td class="mono" style="color:${(s.pct_from_52w_high||0)>-5?'var(--green)':'var(--red)'}">${fmtNum(s.pct_from_52w_high,1)}%</td>
          <td class="mono" style="font-size:10px;color:var(--dim)">$${fmtNum(s.low_52w,0)} â€” $${fmtNum(s.high_52w,0)}</td>
          <td class="mono" style="color:${(s.rs_vs_ma50||0)>=0?'var(--green)':'var(--red)'};">${(s.rs_vs_ma50||0)>=0?'+':''}${fmtNum(s.rs_vs_ma50,1)}%</td>
          <td><div style="display:flex;align-items:center;gap:4px"><div class="bar" style="width:50px"><div class="bar-fill" style="width:${(s.trend_strength||0)/20*100}%;background:${(s.trend_strength||0)>=14?'var(--green)':(s.trend_strength||0)>=8?'var(--yellow)':'var(--red)'}"></div></div><span class="mono" style="font-size:10px">${s.trend_strength||0}/20</span></div></td>
          <td><div class="dot ${s.signal}"></div><span style="font-size:10px;font-weight:600">${s.signal.toUpperCase()}</span></td>
        </tr>`).join('')}
        </tbody></table></div>
      </div>
      <div class="tab-content" id="tab-fundamentals-${i}">
        <div class="tbl-scroll"><table><thead><tr>
          <th onclick="sortG(${i},'ticker')">Ticker</th><th>Mkt Cap</th><th>Fwd P/E</th><th>Trail P/E</th><th>Rev Growth</th><th>Op Margin</th><th>Profit Margin</th><th>EPS (Fwd)</th><th>Beta</th><th>Short %</th><th>Target</th><th>Analyst</th>
        </tr></thead><tbody>
        ${(query?stocks:g.stocks).map(s=>{const f=s.fundamentals||{};return `<tr>
          <td>${tvLink(s.ticker)}</td>
          <td class="mono">${fmtMcap(f.market_cap)}</td>
          <td class="mono">${fmtNum(f.forward_pe,1)}</td>
          <td class="mono">${fmtNum(f.trailing_pe,1)}</td>
          <td class="mono" style="color:${f.revenue_growth!=null?(f.revenue_growth>=0?'var(--green)':'var(--red)'):'var(--dim)'}">${f.revenue_growth!=null?fmtPct(f.revenue_growth):'â€”'}</td>
          <td class="mono" style="color:${f.operating_margin!=null?(f.operating_margin>=0.1?'var(--green)':f.operating_margin>=0?'var(--yellow)':'var(--red)'):'var(--dim)'}">${f.operating_margin!=null?fmtPct(f.operating_margin):'â€”'}</td>
          <td class="mono" style="color:${f.profit_margin!=null?(f.profit_margin>=0?'var(--green)':'var(--red)'):'var(--dim)'}">${f.profit_margin!=null?fmtPct(f.profit_margin):'â€”'}</td>
          <td class="mono">${fmtNum(f.eps_forward,2)}</td>
          <td class="mono">${fmtNum(f.beta,2)}</td>
          <td class="mono" style="color:${f.short_pct_float!=null?(f.short_pct_float>0.1?'var(--orange)':'var(--dim)'):'var(--dim)'}">${f.short_pct_float!=null?fmtPct(f.short_pct_float):'â€”'}</td>
          <td class="mono">${f.target_price?'$'+fmtNum(f.target_price,0):'â€”'}</td>
          <td>${f.recommendation?'<span class="rec rec-'+f.recommendation+'">'+f.recommendation.replace('_',' ')+'</span>':'â€”'}</td>
        </tr>`}).join('')}
        </tbody></table></div>
      </div>
    </div></div>`;
  });

  document.getElementById('mainContent').innerHTML = html || '<div class="empty"><h2>No groups match filter</h2></div>';
}

/* Tooltip for heatmap tiles */
function showTT(e,el){
  const tt = document.getElementById('tooltip');
  tt.innerHTML = `
    <div class="tt-ticker">${el.dataset.ticker}</div>
    <div class="tt-row"><span class="tt-label">Group:</span> <span>${el.dataset.group}</span></div>
    <div class="tt-row"><span class="tt-label">Price:</span> <span>$${el.dataset.price}</span></div>
    <div class="tt-row"><span class="tt-label">Score:</span> <span style="color:${scoreHex(+el.dataset.score)}">${el.dataset.score}</span></div>
    <div class="tt-row"><span class="tt-label">Signal:</span> <span style="text-transform:uppercase">${el.dataset.signal}</span></div>
    <div class="tt-row"><span class="tt-label">YTD:</span> <span style="color:${+el.dataset.ytd>=0?'var(--green)':'var(--red)'}">${+el.dataset.ytd>=0?'+':''}${el.dataset.ytd}%</span></div>
    <div class="tt-row"><span class="tt-label">RSI:</span> <span>${el.dataset.rsi}</span></div>
    <div class="tt-row"><span class="tt-label">Trade:</span> <span class="ts-badge ${tsClass(el.dataset.trade)}" style="font-size:9px;padding:1px 6px;">${el.dataset.trade}</span></div>
    <div class="tt-row"><span class="tt-label">Stage:</span> <span>${el.dataset.stage||'â€”'}</span></div>
  `;
  tt.style.display = 'block';
  tt.style.left = Math.min(e.clientX+12, window.innerWidth-280)+'px';
  tt.style.top = (e.clientY+12)+'px';
}
function hideTT(){document.getElementById('tooltip').style.display='none';}

/* Drill from heatmap group label to group card */
function drillToGroup(gi){
  setView('groups', document.querySelector('.view-btn:last-child'));
  setTimeout(()=>{
    const card = document.getElementById('group-card-'+gi);
    if(card){
      card.scrollIntoView({behavior:'smooth',block:'start'});
      const bd = document.getElementById('bd'+gi);
      const ch = document.getElementById('ch'+gi);
      const hd = bd.previousElementSibling;
      bd.classList.add('open');ch.classList.add('open');hd.classList.add('open');
    }
  },50);
}

function setView(view, btn){
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(view === 'overview'){
    document.getElementById('overviewSection').style.display='';
    document.getElementById('mainContent').style.display='none';
  } else {
    document.getElementById('overviewSection').style.display='none';
    document.getElementById('mainContent').style.display='';
  }
}

function tog(i){
  const b=document.getElementById('bd'+i),c=document.getElementById('ch'+i),h=b.previousElementSibling;
  b.classList.toggle('open');c.classList.toggle('open');h.classList.toggle('open');
}
function switchTab(gi,tab){
  const body=document.getElementById('bd'+gi);
  body.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  body.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+tab+'-'+gi).classList.add('active');
  body.querySelectorAll('.tab-btn').forEach(b=>{if(b.textContent.toLowerCase().includes(tab.substring(0,4)))b.classList.add('active');});
}
function filt(f,btn){
  filter=f;breakerOnly=false;
  document.querySelectorAll('.controls .pill').forEach(b=>b.classList.remove('on','breaker-on'));
  btn.classList.add('on');render();
}
function filtBreaker(btn){
  breakerOnly=!breakerOnly;filter='all';
  document.querySelectorAll('.controls .pill').forEach(b=>b.classList.remove('on','breaker-on'));
  if(breakerOnly){btn.classList.add('breaker-on');}else{document.querySelector('.controls .pill').classList.add('on');}
  render();
}
function search(v){query=v.toLowerCase();render();}
function sortG(gi,field){
  DATA.groups[gi].stocks.sort((a,b)=>{
    let av=a[field],bv=b[field];
    if(field==='ticker')return (av||'').localeCompare(bv||'');
    return (bv||0)-(av||0);
  });
  render();
  setTimeout(()=>{
    setView('groups', document.querySelector('.view-btn:last-child'));
    const b=document.getElementById('bd'+gi),c=document.getElementById('ch'+gi),h=b.previousElementSibling;
    b.classList.add('open');c.classList.add('open');h.classList.add('open');
  },10);
}

async function triggerServerRefresh(){
  /** Call the server API to re-run the signal engine with fresh market data. */
  if(refreshInProgress) return;
  refreshInProgress = true;
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning'); btn.disabled = true;
  btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refreshing...';

  try {
    // Trigger refresh on server
    await fetch('/api/refresh', {method:'POST'});

    // Poll for completion (check every 5 seconds, max 10 min)
    let done = false;
    for(let i=0; i<120 && !done; i++){
      await new Promise(r=>setTimeout(r,5000));
      try{
        const st = await fetch('/api/refresh/status');
        const status = await st.json();
        if(!status.running){
          done = true;
          // Reload dashboard data
          await loadData();
        }
      }catch(e){}
    }
    if(!done){
      // Timeout â€” just reload whatever we have
      await loadData();
    }
  } catch(e) {
    console.error('Refresh failed:', e);
    // Still try to reload in case the server has new data
    await loadData();
  } finally {
    refreshInProgress = false;
    btn.classList.remove('spinning'); btn.disabled = false;
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refresh';
    countdownSec = REFRESH_INTERVAL;
  }
}

function manualRefresh(){
  triggerServerRefresh();
}
function toggleAuto(){
  const t=document.getElementById('autoToggle');autoRefresh=!autoRefresh;
  t.classList.toggle('on',autoRefresh);
  if(autoRefresh){startAuto();}else{stopAuto();}
}
function fmtCountdown(sec){
  if(sec>=60){const m=Math.floor(sec/60);const s=sec%60;return m+'m'+(s>0?' '+s+'s':'');}
  return sec+'s';
}
function startAuto(){
  stopAuto();
  countdownSec=REFRESH_INTERVAL;
  countdownTimer=setInterval(()=>{
    countdownSec--;
    const el=document.getElementById('countdown');
    if(el) el.textContent=fmtCountdown(countdownSec);
    if(countdownSec<=0){
      countdownSec=REFRESH_INTERVAL;
      triggerServerRefresh();
    }
  },1000);
}
function stopAuto(){
  if(countdownTimer){clearInterval(countdownTimer);countdownTimer=null;}
  const el=document.getElementById('countdown');if(el) el.textContent='off';
}

setInterval(updateTimestampDisplay, 30000);
loadData();
if(autoRefresh)startAuto();
</script>
</body>
</html>
